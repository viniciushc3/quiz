<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Master</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        
        <div id="screenSelection">
            <h2 style="margin-bottom:10px;">ğŸ“‚ Escolha o Quiz</h2>
            <div class="quiz-card" onclick="loadQ('./quizzes/geral.json')">
                <span>ğŸŒ Conhecimentos Gerais</span><span>ğŸ§ </span>
            </div>
            <div class="quiz-card" onclick="loadQ('./quizzes/series.json')">
                <span>ğŸ¬ SÃ©ries e Filmes</span><span>ğŸ¿</span>
            </div>
        </div>

        <div id="screenControl" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div style="background:#333; color:white; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span id="statusBar">Pronto</span>
                <button onclick="location.reload()" style="font-size:0.8rem; padding:5px;">Sair</button>
            </div>
            
            <div class="admin-scroll" id="qList"></div>

            <div style="padding-top:10px; border-top:1px solid #ccc; background:#f0f2f5;">
                <button id="btnNextAction" onclick="updateState('lobby')" class="btn" style="background:#555; margin-bottom:10px; border:2px solid #333;">
                    ğŸ  Ir para Lobby
                </button>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    <button onclick="updateState('leaderboard')" class="btn blue" style="margin:0;">ğŸ“Š Ranking</button>
                    <button onclick="updateState('podium')" class="btn yellow" style="margin:0;">ğŸ† PÃ³dio</button>
                </div>
                <div style="margin-top:5px;">
                    <button onclick="nuke()" class="btn red" style="margin:0; font-size:0.9rem;">ğŸ—‘ï¸ Zerar Players</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, update, get, set, onValue, off, keepScreenAwake, loadQuestions } from './game.js';

        let quizData = [];
        let timer = null;
        let qStartTime = 0;
        let isQuestionRunning = false;
        let playerListener = null;
        const sfx = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');

        keepScreenAwake();

        window.loadQ = async function(path) {
            sfx.play();
            quizData = await loadQuestions(path);
            if(!quizData.length) return;

            const list = document.getElementById('qList');
            list.innerHTML = '';
            quizData.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.id = `btnQ${i}`;
                btn.className = 'btn';
                btn.style.background = "white"; btn.style.color = "#333"; btn.style.textAlign = "left";
                btn.innerHTML = `<b>#${i+1}</b> ${q.text.substring(0,30)}...`;
                btn.onclick = () => { sfx.play(); runQ(i); };
                list.appendChild(btn);
            });

            document.getElementById('screenSelection').classList.add('hidden');
            document.getElementById('screenControl').classList.remove('hidden');
            updateState('lobby');
        }

        window.updateState = (screen) => { 
            if(playerListener) { off(ref(db, 'players'), playerListener); playerListener = null; }
            if(timer) clearTimeout(timer);
            update(ref(db, 'gameState'), { screen: screen });
        }
        
        window.nuke = () => { if(confirm("Apagar todos jogadores?")) set(ref(db, 'players'), {}); }

        window.runQ = async function(idx) {
            if(timer) clearTimeout(timer);
            if(playerListener) off(ref(db, 'players'), playerListener);
            
            isQuestionRunning = true;
            qStartTime = Date.now();
            const timeLimit = 30; // 30 segundos

            // Feedback Visual
            document.querySelectorAll('#qList button').forEach(b => b.style.background = "white");
            document.getElementById(`btnQ${idx}`).style.background = "#e6f4ff";
            document.getElementById('statusBar').innerText = `Pergunta ${idx+1} rolando...`;

            // Resetar Players
            const pSnap = await get(ref(db, 'players'));
            const updates = {};
            if(pSnap.exists()) {
                pSnap.forEach(c => { 
                    updates[`players/${c.key}/lastAnswer`] = null; 
                    updates[`players/${c.key}/status`] = 'thinking'; 
                    updates[`players/${c.key}/answerTime`] = null; 
                });
            }

            // CORREÃ‡ÃƒO: ENVIA A PERGUNTA INTEIRA PARA A TV
            const currentQ = quizData[idx];
            
            updates['gameState'] = { 
                screen: 'question', 
                // Envia dados completos para a TV nÃ£o precisar do JSON
                questionData: {
                    text: currentQ.text,
                    answers: currentQ.answers,
                    correct: currentQ.correct,
                    image: currentQ.image || null,
                    video: currentQ.video || null,
                    audio: currentQ.audio || null
                },
                showResult: false, 
                endTime: qStartTime+(timeLimit*1000) 
            };
            
            await update(ref(db), updates);

            // Monitorar Respostas (Auto-Stop)
            const playersRef = ref(db, 'players');
            playerListener = onValue(playersRef, (snap) => {
                if(!isQuestionRunning) return;
                const players = snap.val();
                if(!players) return;

                let answered = 0, total = 0;
                Object.values(players).forEach(p => {
                    total++;
                    if(p.lastAnswer !== undefined && p.lastAnswer !== null) answered++;
                });

                document.getElementById('statusBar').innerText = `Resp: ${answered} / ${total}`;
                
                // Se todos responderam, encerra
                if(total > 0 && answered >= total) finishQ(idx);
            });

            timer = setTimeout(() => { if(isQuestionRunning) finishQ(idx); }, timeLimit*1000);
        }

        async function finishQ(idx) {
            if(!isQuestionRunning) return;
            isQuestionRunning = false;
            if(playerListener) off(ref(db, 'players'), playerListener);
            if(timer) clearTimeout(timer);

            const pSnap = await get(ref(db, 'players'));
            const correct = quizData[idx].correct;
            const updates = {};
            
            updates['gameState/showResult'] = true;

            if(pSnap.exists()) pSnap.forEach(c => {
                const p = c.val();
                if(p.lastAnswer === correct) {
                    const streak = (p.streak||0) + 1;
                    let taken = (p.answerTime || (qStartTime+30000)) - qStartTime;
                    if(taken < 0) taken = 0; if(taken > 30000) taken = 30000;
                    
                    const bonus = Math.floor(500 * (1 - (taken/30000))); 
                    updates[`players/${c.key}/score`] = (p.score||0) + 500 + bonus + (streak>2?200:0);
                    updates[`players/${c.key}/streak`] = streak;
                    updates[`players/${c.key}/status`] = 'correct';
                } else {
                    updates[`players/${c.key}/streak`] = 0;
                    updates[`players/${c.key}/status`] = 'wrong';
                }
            });

            await update(ref(db), updates);
            document.getElementById('statusBar').innerText = "Resultado!";
            
            // BotÃ£o AvanÃ§ar
            const btnNext = document.getElementById('btnNextAction');
            if(idx + 1 < quizData.length) {
                btnNext.innerText = `â¡ï¸ LanÃ§ar Pergunta ${idx + 2}`;
                btnNext.onclick = () => { sfx.play(); runQ(idx + 1); };
                btnNext.style.background = "#26890c";
                const nextEl = document.getElementById(`btnQ${idx+1}`);
                if(nextEl) nextEl.scrollIntoView({block:'center'});
            } else {
                btnNext.innerText = "ğŸ† Ir para PÃ³dio";
                btnNext.onclick = () => updateState('podium');
                btnNext.style.background = "#ffc00a";
                btnNext.style.color = "black";
            }
        }
    </script>
</body>
</html>