<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Controle</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { background: #f0f2f5; color: #333; height: 100vh; display: flex; flex-direction: column; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        
        .quiz-card { 
            background: white; padding: 15px; border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer;
            border-left: 6px solid #333; display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #ddd;
        }
        
        .q-info h3 { margin: 0; font-size: 1rem; color: #333; }
        .q-info p { margin: 4px 0 0 0; font-size: 0.75rem; color: #777; }
        .q-icon { font-size: 1.8rem; }
        
        .status-bar { background:#333; color:white; padding:12px 15px; display:flex; justify-content:space-between; align-items:center; }
        .admin-scroll { flex: 1; overflow-y: auto; padding: 10px; background: #eef1f5; }
        
        .q-btn {
            display: block; width: 100%; background: white; border: 1px solid #ccc;
            text-align: left; padding: 15px; margin-bottom: 8px; border-radius: 8px;
            color: #333; cursor: pointer;
        }
        .q-btn.active { background: #e6f4ff; border-color: #45a3e5; font-weight: bold; border-left: 5px solid #45a3e5; }
        
        .bottom-controls { padding:15px; background:white; border-top:1px solid #ddd; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="admin-container">
        
        <div id="screenSelection">
            <h2 style="padding: 20px 20px 0 20px; margin: 0;">üìÇ Escolha o Quiz</h2>
            <div class="grid-menu" id="quizMenuContainer"></div>
        </div>

        <div id="screenControl" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div class="status-bar">
                <span id="statusBar" style="font-weight:bold;">Pronto</span>
                <button onclick="changeQuiz()" style="font-size:0.8rem; padding:6px 12px; border-radius:4px;">Trocar</button>
            </div>
            
            <div class="admin-scroll" id="qList"></div>

            <div class="bottom-controls">
                <button onclick="updateState('lobby')" class="btn" style="width:100%; padding:15px; background:#444; color:white; border:none; border-radius:8px; margin-bottom:10px;">üè† Ir para o Lobby</button>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="updateState('leaderboard')" class="btn" style="padding:10px; background:#45a3e5; color:white; border:none; border-radius:8px;">üìä Ranking</button>
                    <button onclick="updateState('podium')" class="btn" style="padding:10px; background:#ffc00a; color:black; border:none; border-radius:8px;">üèÜ P√≥dio</button>
                </div>
                <button onclick="nuke()" class="btn" style="width:100%; padding:10px; background:white; color:red; border:1px solid red; border-radius:8px; margin-top:10px;">üóëÔ∏è Zerar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, update, get, set, onValue, off, keepScreenAwake, loadQuestions } from './game.js?v=4';

        let quizData = [];
        let timer = null;
        let qStartTime = 0;
        let isQuestionRunning = false;
        let playerListener = null;
        
        const sfx = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');
        keepScreenAwake();

        // 1. MENU
        function initMenu() {
            const container = document.getElementById('quizMenuContainer');
            if(!container) return;

            const quizzes = [
                { file: "geral.json", title: "Geral", desc: "Perguntas Variadas", icon: "üåç", color: "#45a3e5" },
                { file: "series.json", title: "S√©ries", desc: "Filmes e TV", icon: "üé¨", color: "#e21b3c" },
                { file: "geek.json", title: "Geek", desc: "Games e Animes", icon: "üëæ", color: "#26890c" },
                { file: "familia.json", title: "Fam√≠lia", desc: "Nosso Quiz", icon: "üè†", color: "#ffc00a" }
            ];

            container.innerHTML = '';
            quizzes.forEach(q => {
                const card = document.createElement('div');
                card.className = 'quiz-card';
                card.style.borderLeftColor = q.color;
                card.innerHTML = `<div class="q-info"><h3>${q.title}</h3><p>${q.desc}</p></div><div class="q-icon">${q.icon}</div>`;
                card.onclick = function() { loadQ(`./quizzes/${q.file}`); };
                container.appendChild(card);
            });
        }

        // 2. FUN√á√ïES GLOBAIS
        window.loadQ = async function(path) {
            sfx.play();
            try {
                const response = await fetch(path + '?t=' + Date.now());
                if(!response.ok) throw new Error("Arquivo n√£o encontrado.");
                const text = await response.text();
                quizData = JSON.parse(text);

                const list = document.getElementById('qList');
                list.innerHTML = `<div style="padding:10px; color:#666;">${quizData.length} perguntas carregadas:</div>`;

                quizData.forEach((q, i) => {
                    const btn = document.createElement('button');
                    btn.id = `btnQ${i}`; btn.className = 'q-btn'; 
                    btn.innerHTML = `<b style="color:#45a3e5">#${i+1}</b> ${q.text.substring(0,35)}...`;
                    btn.onclick = () => { sfx.play(); runQ(i); };
                    list.appendChild(btn);
                });

                document.getElementById('screenSelection').classList.add('hidden');
                document.getElementById('screenControl').classList.remove('hidden');
                updateState('lobby');
            } catch (e) { alert("ERRO: " + e.message); }
        }

        window.changeQuiz = function() {
            if(confirm("Trocar de quiz?")) {
                document.getElementById('screenControl').classList.add('hidden');
                document.getElementById('screenSelection').classList.remove('hidden');
                updateState('lobby');
            }
        }

        window.updateState = function(screen) { 
            if(playerListener) { off(ref(db, 'players'), playerListener); playerListener = null; }
            if(timer) clearTimeout(timer);
            update(ref(db, 'gameState'), { screen: screen });
        }

        window.nuke = function() { if(confirm("Certeza?")) set(ref(db, 'players'), {}); }

        window.runQ = async function(idx) {
             if(timer) clearTimeout(timer);
             if(playerListener) off(ref(db, 'players'), playerListener);
             
             isQuestionRunning = true; 
             qStartTime = Date.now();
             const q = quizData[idx]; // Dados da pergunta atual

             // Visual
             document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
             const cb = document.getElementById(`btnQ${idx}`);
             if(cb) { cb.classList.add('active'); cb.scrollIntoView({behavior:'smooth', block:'center'}); }
             document.getElementById('statusBar').innerText = `Pergunta ${idx+1} rolando...`;

             // Reset Players
             const pSnap = await get(ref(db, 'players'));
             const updates = {};
             if(pSnap.exists()) pSnap.forEach(c => { 
                 updates[`players/${c.key}/lastAnswer`] = null; 
                 updates[`players/${c.key}/status`] = 'thinking'; 
                 updates[`players/${c.key}/answerTime`] = null; 
             });

             // *** AQUI EST√Å A CORRE√á√ÉO M√ÅGICA ***
             // Enviamos os DADOS da pergunta, n√£o s√≥ o √≠ndice
             updates['gameState'] = { 
                 screen: 'question', 
                 showResult: false, 
                 endTime: qStartTime + 20000,
                 // Dados completos para a TV ler:
                 qText: q.text,
                 qAnswers: q.answers,
                 qCorrect: q.correct, // TV usa isso para saber qual barra pintar de verde no final
                 qImage: q.image || null,
                 qVideo: q.video || null,
                 qAudio: q.audio || null
             };
             
             await update(ref(db), updates);

             // Monitoramento
             playerListener = onValue(ref(db, 'players'), (snap) => {
                 if(!isQuestionRunning) return;
                 const ps = snap.val(); 
                 let ans=0, tot=0;
                 if(ps) Object.values(ps).forEach(p => { tot++; if(p.lastAnswer!=null) ans++; });
                 document.getElementById('statusBar').innerText = `Resp: ${ans} / ${tot}`;
                 if(tot>0 && ans>=tot) finishQ(idx);
             });

             timer = setTimeout(() => { if(isQuestionRunning) finishQ(idx); }, 20000);
        }

        async function finishQ(idx) {
            if(!isQuestionRunning) return; 
            isQuestionRunning = false;
            if(playerListener) off(ref(db, 'players'), playerListener); clearTimeout(timer);
            
            const pSnap = await get(ref(db, 'players'));
            const correct = quizData[idx].correct;
            const updates = {};
            updates['gameState/showResult'] = true;

            if(pSnap.exists()) pSnap.forEach(c => {
                const p = c.val();
                if(p.lastAnswer === correct) {
                    const streak = (p.streak||0)+1;
                    let taken = (p.answerTime||(qStartTime+20000)) - qStartTime;
                    if(taken<0) taken=0; if(taken>20000) taken=20000;
                    const pts = 500 + Math.floor(500*(1-(taken/20000))) + (streak>2?200:0);
                    updates[`players/${c.key}/score`] = (p.score||0)+pts; 
                    updates[`players/${c.key}/streak`] = streak; 
                    updates[`players/${c.key}/status`] = 'correct';
                } else {
                    updates[`players/${c.key}/streak`] = 0; 
                    updates[`players/${c.key}/status`] = 'wrong';
                }
            });
            await update(ref(db), updates);
            document.getElementById('statusBar').innerText = "Encerrado.";
        }

        initMenu();
    </script>
</body>
</html>