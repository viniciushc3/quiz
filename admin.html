<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Ultimate</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos exclusivos do Admin */
        .admin-container { background: #f0f2f5; color: #333; height: 100vh; display: flex; flex-direction: column; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .quiz-card { 
            background: white; padding: 15px; border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
            text-align: left; transition: transform 0.1s;
            border-left: 6px solid #333; display: flex; justify-content: space-between; align-items: center;
        }
        .quiz-card:active { transform: scale(0.96); background: #fafafa; }
        .q-info h3 { margin: 0; font-size: 1rem; color: #333; font-weight: 700; }
        .q-info p { margin: 4px 0 0 0; font-size: 0.75rem; color: #777; }
        .q-icon { font-size: 1.8rem; }
        
        /* Status Bar */
        .status-bar {
            background:#333; color:white; padding:12px 15px; 
            display:flex; justify-content:space-between; align-items:center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;
        }
        
        /* Lista de Perguntas */
        .admin-scroll { flex: 1; overflow-y: auto; padding: 10px; background: #eef1f5; }
        .q-btn {
            width: 100%; background: white; border: none; text-align: left;
            padding: 12px; margin-bottom: 8px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.95rem; color: #444;
            transition: 0.2s; border-left: 4px solid transparent;
        }
        .q-btn.active { background: #e6f4ff; border-left-color: #45a3e5; color: #000; }
        
        /* Controles Inferiores */
        .bottom-controls { padding:15px; background:white; border-top:1px solid #ddd; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div class="admin-container">
        
        <div id="screenSelection">
            <h2 style="padding: 20px 20px 0 20px; margin: 0;">üìÇ Escolha o Quiz</h2>
            <p style="padding: 0 20px; color: #666; font-size: 0.9rem;">Toque para iniciar:</p>
            
            <div class="grid-menu" id="quizMenuContainer">
                </div>
        </div>

        <div id="screenControl" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            
            <div class="status-bar">
                <span id="statusBar" style="font-weight:bold;">Pronto</span>
                <button onclick="changeQuiz()" style="font-size:0.8rem; padding:6px 12px; background:#555; border:1px solid #777; color:white; border-radius:6px; cursor:pointer;">Trocar</button>
            </div>
            
            <div class="admin-scroll" id="qList"></div>

            <div class="bottom-controls">
                <button id="btnNextAction" onclick="updateState('lobby')" class="btn" style="background:#444; margin-bottom:10px; border:none; font-weight:bold; color: white;">
                    üè† Ir para o Lobby
                </button>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="updateState('leaderboard')" class="btn blue" style="margin:0; font-size:0.9rem;">üìä Ranking</button>
                    <button onclick="updateState('podium')" class="btn yellow" style="margin:0; font-size:0.9rem;">üèÜ P√≥dio</button>
                </div>
                
                <div style="margin-top:10px;">
                    <button onclick="nuke()" class="btn red" style="margin:0; font-size:0.8rem; padding: 10px; background: white; color: red; border: 1px solid red; box-shadow: none;">üóëÔ∏è Zerar Jogadores</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, update, get, set, onValue, off, keepScreenAwake, loadQuestions } from './game.js';

        let quizData = [];
        let timer = null;
        let qStartTime = 0;
        let isQuestionRunning = false;
        let playerListener = null;
        
        const sfx = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');
        keepScreenAwake();

        // --- 1. CONFIGURA√á√ÉO DOS QUIZZES (Edite aqui se criar novos arquivos) ---
        window.onload = function() {
            const container = document.getElementById('quizMenuContainer');
            
            // LISTA MANUAL PARA N√ÉO TRAVAR O CARREGAMENTO
            const quizzes = [
                {
                    "file": "geral.json",
                    "title": "Geral",
                    "desc": "Variados",
                    "icon": "üåç",
                    "color": "#45a3e5"
                },
                {
                    "file": "series.json",
                    "title": "S√©ries",
                    "desc": "Filmes e TV",
                    "icon": "üé¨",
                    "color": "#e21b3c"
                },
                {
                    "file": "geek.json",
                    "title": "Geek",
                    "desc": "Games/Anime",
                    "icon": "üëæ",
                    "color": "#26890c"
                },
                {
                    "file": "familia.json",
                    "title": "Fam√≠lia",
                    "desc": "Pessoal",
                    "icon": "üè†",
                    "color": "#ffc00a"
                }
            ];

            container.innerHTML = '';
            
            quizzes.forEach(q => {
                const card = document.createElement('div');
                card.className = 'quiz-card';
                card.style.borderLeftColor = q.color;
                card.innerHTML = `<div class="q-info"><h3>${q.title}</h3><p>${q.desc}</p></div><div class="q-icon">${q.icon}</div>`;
                card.onclick = () => loadQ(`./quizzes/${q.file}`);
                container.appendChild(card);
            });
        }

        // --- 2. CARREGAR PERGUNTAS ---
        window.loadQ = async function(path) {
            sfx.play();
            try {
                // Adiciona timestamp (?t=...) para evitar cache velho
                quizData = await loadQuestions(path + '?t=' + Date.now());
                
                if(!quizData || quizData.length === 0) {
                    alert(`ERRO: O arquivo "${path}" n√£o foi encontrado ou est√° vazio.`);
                    return;
                }

                const list = document.getElementById('qList');
                list.innerHTML = `<div style="padding:10px; color:#666; font-size:0.8rem;">Toque em uma pergunta para iniciar:</div>`;

                quizData.forEach((q, i) => {
                    const btn = document.createElement('button');
                    btn.id = `btnQ${i}`; 
                    btn.className = 'q-btn';
                    btn.innerHTML = `<b style="color:#45a3e5">#${i+1}</b> ${q.text.substring(0,35)}...`;
                    btn.onclick = () => { sfx.play(); runQ(i); };
                    list.appendChild(btn);
                });

                document.getElementById('screenSelection').classList.add('hidden');
                document.getElementById('screenControl').classList.remove('hidden');
                updateState('lobby');

            } catch (e) {
                alert("Erro ao ler JSON: " + e.message);
            }
        }

        window.changeQuiz = function() {
            if(confirm("Sair deste quiz?")) {
                document.getElementById('screenControl').classList.add('hidden');
                document.getElementById('screenSelection').classList.remove('hidden');
                updateState('lobby');
            }
        }

        // --- 3. CONTROLE DE ESTADO ---
        window.updateState = (screen) => { 
            if(playerListener) { off(ref(db, 'players'), playerListener); playerListener = null; }
            if(timer) clearTimeout(timer);
            
            update(ref(db, 'gameState'), { screen: screen });
            
            const btn = document.getElementById('btnNextAction');
            if(screen === 'lobby') {
                btn.innerText = "‚è≥ Aguardando Jogadores..."; 
                btn.style.background = "#444";
                btn.onclick = () => alert("Selecione uma pergunta da lista!");
            }
        }

        window.nuke = () => { if(confirm("Certeza? Isso apaga todos os pontos.")) set(ref(db, 'players'), {}); }

        // --- 4. RODAR PERGUNTA (L√ìGICA PRINCIPAL) ---
        window.runQ = async function(idx) {
             if(timer) clearTimeout(timer);
             if(playerListener) off(ref(db, 'players'), playerListener);
             
             isQuestionRunning = true; 
             qStartTime = Date.now();
             
             // Visual
             document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
             const currentBtn = document.getElementById(`btnQ${idx}`);
             if(currentBtn) {
                 currentBtn.classList.add('active');
                 currentBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
             }

             document.getElementById('statusBar').innerText = `Pergunta ${idx+1} rolando...`;

             // Reset dos Jogadores
             const pSnap = await get(ref(db, 'players'));
             const updates = {};
             if(pSnap.exists()) pSnap.forEach(c => { 
                 updates[`players/${c.key}/lastAnswer`] = null; 
                 updates[`players/${c.key}/status`] = 'thinking'; 
                 updates[`players/${c.key}/answerTime`] = null; 
             });
             
             updates['gameState'] = { screen: 'question', currentQuestion: idx, showResult: false, endTime: qStartTime+20000 };
             await update(ref(db), updates);

             // Monitorar Respostas (Auto-Stop)
             playerListener = onValue(ref(db, 'players'), (snap) => {
                 if(!isQuestionRunning) return;
                 const ps = snap.val(); 
                 if(!ps) return;
                 
                 let ans=0, tot=0;
                 Object.values(ps).forEach(p => { tot++; if(p.lastAnswer!=null) ans++; });
                 
                 document.getElementById('statusBar').innerText = `Respondido: ${ans} / ${tot}`;
                 
                 // Se todos responderam
                 if(tot>0 && ans>=tot) finishQ(idx);
             });

             // Timeout de seguran√ßa (20s)
             timer = setTimeout(() => { if(isQuestionRunning) finishQ(idx); }, 20000);
        }

        // --- 5. FINALIZAR PERGUNTA ---
        async function finishQ(idx) {
            if(!isQuestionRunning) return; 
            isQuestionRunning = false;
            if(playerListener) off(ref(db, 'players'), playerListener); 
            clearTimeout(timer);
            
            const pSnap = await get(ref(db, 'players'));
            const correct = quizData[idx].correct;
            const updates = {};
            updates['gameState/showResult'] = true;

            if(pSnap.exists()) pSnap.forEach(c => {
                const p = c.val();
                if(p.lastAnswer === correct) {
                    const streak = (p.streak||0)+1;
                    // Pontua√ß√£o Baseada em Tempo (20s max)
                    let taken = (p.answerTime||(qStartTime+20000)) - qStartTime;
                    if(taken<0) taken=0; if(taken>20000) taken=20000;
                    
                    const pts = 500 + Math.floor(500*(1-(taken/20000))) + (streak>2?200:0);
                    
                    updates[`players/${c.key}/score`] = (p.score||0)+pts; 
                    updates[`players/${c.key}/streak`] = streak; 
                    updates[`players/${c.key}/status`] = 'correct';
                } else {
                    updates[`players/${c.key}/streak`] = 0; 
                    updates[`players/${c.key}/status`] = 'wrong';
                }
            });
            await update(ref(db), updates);
            document.getElementById('statusBar').innerText = "Encerrado.";
            
            // Bot√£o Pr√≥xima Pergunta
            const nextIdx = idx+1;
            const btn = document.getElementById('btnNextAction');
            if(nextIdx < quizData.length) {
                btn.innerText = `‚û°Ô∏è Lan√ßar Pergunta ${nextIdx+1}`;
                btn.onclick = () => { sfx.play(); runQ(nextIdx); };
                btn.style.background = "#26890c"; // Verde
            } else {
                btn.innerText = "üèÜ Ir para o P√≥dio";
                btn.onclick = () => updateState('podium');
                btn.style.background = "#ffc00a"; 
                btn.style.color="black";
            }
        }
    </script>
</body>
</html>