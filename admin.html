<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        
        <div id="screenSelection">
            <h2 style="margin-bottom:10px;">ğŸ“‚ Escolha o Quiz</h2>
            <div class="quiz-card" onclick="loadQ('./quizzes/geral.json')">
                <span>ğŸŒ Conhecimentos Gerais</span><span>ğŸ§ </span>
            </div>
             </div>

        <div id="screenControl" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div style="background:#333; color:white; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span id="statusBar">Aguardando...</span>
                <button onclick="location.reload()" style="font-size:0.8rem; padding:5px;">Sair</button>
            </div>
            
            <div class="admin-scroll" id="qList"></div>

            <div style="padding-top:10px; border-top:1px solid #ccc; background:#f0f2f5;">
                
                <button id="btnNextAction" onclick="updateState('lobby')" class="btn" style="background:#555; margin-bottom:10px; border:2px solid #333;">
                    ğŸ  Ir para o Lobby (Aguardar Jogadores)
                </button>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    <button onclick="updateState('leaderboard')" class="btn blue" style="margin:0;">ğŸ“Š Ranking</button>
                    <button onclick="updateState('podium')" class="btn yellow" style="margin:0;">ğŸ† PÃ³dio</button>
                </div>
                <div style="margin-top:5px;">
                    <button onclick="nuke()" class="btn red" style="margin:0; font-size:0.9rem;">ğŸ—‘ï¸ Zerar Tudo</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, update, get, set, onValue, off, keepScreenAwake, loadQuestions } from './game.js';

        let quizData = [];
        let timer = null;
        let qStartTime = 0;
        let isQuestionRunning = false;
        let playerListener = null; // Para vigiar respostas
        
        const sfx = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');

        keepScreenAwake();

        // --- CARREGAMENTO ---
        window.loadQ = async function(path) {
            sfx.play();
            quizData = await loadQuestions(path);
            if(!quizData.length) return;

            const list = document.getElementById('qList');
            list.innerHTML = '';
            
            quizData.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.id = `btnQ${i}`;
                btn.className = 'btn';
                btn.style.background = "white"; btn.style.color = "#333"; btn.style.textAlign = "left";
                btn.innerHTML = `<b>#${i+1}</b> ${q.text.substring(0,30)}...`;
                btn.onclick = () => { sfx.play(); runQ(i); };
                list.appendChild(btn);
            });

            document.getElementById('screenSelection').classList.add('hidden');
            document.getElementById('screenControl').classList.remove('hidden');
            
            // ForÃ§a ir para o Lobby ao carregar
            updateState('lobby');
        }

        // --- ESTADOS GERAIS ---
        window.updateState = (screen) => { 
            // Cancela monitoramento anterior se houver
            if(playerListener) { off(ref(db, 'players'), playerListener); playerListener = null; }
            if(timer) clearTimeout(timer);
            
            update(ref(db, 'gameState'), { screen: screen });
            
            // Atualiza UI do botÃ£o principal
            const btn = document.getElementById('btnNextAction');
            if(screen === 'lobby') {
                btn.innerText = "â³ Aguardando no Lobby...";
                btn.onclick = () => alert("Escolha uma pergunta abaixo para comeÃ§ar!");
                btn.style.background = "#555";
            }
        }

        window.nuke = () => { if(confirm("Isso vai apagar todos os jogadores. Confirmar?")) set(ref(db, 'players'), {}); }

        // --- RODAR PERGUNTA ---
        window.runQ = async function(idx) {
            // 1. Limpeza e Setup
            if(timer) clearTimeout(timer);
            if(playerListener) { off(ref(db, 'players'), playerListener); } // Para listener antigo
            
            isQuestionRunning = true;
            qStartTime = Date.now();
            const timeLimit = 20; // Segundos

            // Feedback Visual no Admin
            document.querySelectorAll('#qList button').forEach(b => b.style.background = "white");
            document.getElementById(`btnQ${idx}`).style.background = "#e6f4ff";
            document.getElementById('statusBar').innerText = `Pergunta ${idx+1} rolando...`;

            // 2. Resetar Jogadores (CRUCIAL PARA CONTINUIDADE)
            // Fazemos isso ANTES de mudar a tela da TV
            const pSnap = await get(ref(db, 'players'));
            const updates = {};
            
            let totalPlayers = 0;
            if(pSnap.exists()) {
                pSnap.forEach(c => { 
                    totalPlayers++;
                    updates[`players/${c.key}/lastAnswer`] = null; 
                    updates[`players/${c.key}/status`] = 'thinking'; 
                    updates[`players/${c.key}/answerTime`] = null; 
                });
            }

            // Define estado da pergunta
            updates['gameState'] = { 
                screen: 'question', 
                currentQuestion: idx, 
                showResult: false, 
                endTime: qStartTime+(timeLimit*1000) 
            };
            
            await update(ref(db), updates);

            // 3. MONITORAMENTO DE RESPOSTAS (AUTO-STOP)
            const playersRef = ref(db, 'players');
            playerListener = onValue(playersRef, (snap) => {
                if(!isQuestionRunning) return;

                const players = snap.val();
                if(!players) return;

                let answeredCount = 0;
                let currentTotal = 0;

                Object.values(players).forEach(p => {
                    currentTotal++;
                    if(p.lastAnswer !== undefined && p.lastAnswer !== null) {
                        answeredCount++;
                    }
                });

                // Atualiza status no Admin
                document.getElementById('statusBar').innerText = `Resp: ${answeredCount} / ${currentTotal}`;

                // SE TODOS RESPONDERAM
                if(currentTotal > 0 && answeredCount >= currentTotal) {
                    console.log("Todos responderam! Encerrando...");
                    finishQ(idx);
                }
            });

            // Timer de seguranÃ§a (caso alguÃ©m caia e nÃ£o responda)
            timer = setTimeout(() => {
                if(isQuestionRunning) finishQ(idx);
            }, timeLimit * 1000);
        }

        // --- FINALIZAR PERGUNTA ---
        async function finishQ(idx) {
            if(!isQuestionRunning) return;
            isQuestionRunning = false;
            
            // Para de vigiar as respostas
            if(playerListener) { off(ref(db, 'players'), playerListener); playerListener = null; }
            if(timer) clearTimeout(timer);

            const pSnap = await get(ref(db, 'players'));
            const correct = quizData[idx].correct;
            const updates = {};
            
            // Avisa a TV para mostrar resultado
            updates['gameState/showResult'] = true;

            // Calcula Pontos
            if(pSnap.exists()) pSnap.forEach(c => {
                const p = c.val();
                if(p.lastAnswer === correct) {
                    const streak = (p.streak||0) + 1;
                    
                    // CÃ¡lculo de Tempo
                    let taken = (p.answerTime || (qStartTime+20000)) - qStartTime;
                    if(taken < 0) taken = 0; if(taken > 20000) taken = 20000;
                    
                    // FÃ³rmula: 1000 pts base + bÃ´nus de tempo
                    const bonus = Math.floor(500 * (1 - (taken/20000))); 
                    const totalPoints = 500 + bonus + (streak>2?200:0);

                    updates[`players/${c.key}/score`] = (p.score||0) + totalPoints;
                    updates[`players/${c.key}/streak`] = streak;
                    updates[`players/${c.key}/status`] = 'correct';
                } else {
                    updates[`players/${c.key}/streak`] = 0;
                    updates[`players/${c.key}/status`] = 'wrong';
                }
            });

            await update(ref(db), updates);
            document.getElementById('statusBar').innerText = "Resultado exibido!";
            
            // Prepara botÃ£o para PRÃ“XIMA pergunta
            const nextIdx = idx + 1;
            const btnNext = document.getElementById('btnNextAction');
            if(nextIdx < quizData.length) {
                btnNext.innerText = `â¡ï¸ LanÃ§ar Pergunta ${nextIdx + 1}`;
                btnNext.onclick = () => { sfx.play(); runQ(nextIdx); };
                btnNext.style.background = "#26890c"; // Verde para indicar continuidade
                
                // Scroll automÃ¡tico para a prÃ³xima pergunta na lista
                const nextBtnEl = document.getElementById(`btnQ${nextIdx}`);
                if(nextBtnEl) nextBtnEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } else {
                btnNext.innerText = "ğŸ† Fim! Ir para o PÃ³dio";
                btnNext.onclick = () => updateState('podium');
                btnNext.style.background = "#ffc00a";
                btnNext.style.color = "black";
            }
        }
    </script>
</body>
</html>