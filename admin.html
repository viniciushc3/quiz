<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Controle</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS EspecÃ­fico do Menu Admin para garantir que apareÃ§a */
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .quiz-card { 
            background: white; padding: 20px; border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer;
            text-align: left; transition: transform 0.1s;
            border-left: 5px solid #333;
        }
        .quiz-card:active { transform: scale(0.98); background: #f9f9f9; }
        .quiz-card h3 { margin: 0; font-size: 1rem; color: #333; }
        .quiz-card p { margin: 5px 0 0 0; font-size: 0.8rem; color: #666; }
        
        /* Cores das Bordas */
        .border-blue { border-left-color: #45a3e5; }
        .border-red { border-left-color: #e21b3c; }
        .border-green { border-left-color: #26890c; }
        .border-yellow { border-left-color: #ffc00a; }
    </style>
</head>
<body>
    <div class="admin-container">
        
        <div id="screenSelection">
            <h2 style="padding: 0 10px; margin-bottom: 5px;">ğŸ“‚ Selecione o Quiz</h2>
            <p style="padding: 0 10px; color: #666; font-size: 0.9rem;">Certifique-se que os arquivos JSON existem.</p>
            
            <div class="grid-menu">
                <div class="quiz-card border-blue" onclick="loadQ('./quizzes/geral.json')">
                    <h3>ğŸŒ Geral</h3>
                    <p>Perguntas Variadas</p>
                </div>

                <div class="quiz-card border-red" onclick="loadQ('./quizzes/series.json')">
                    <h3>ğŸ¬ SÃ©ries</h3>
                    <p>Filmes e TV</p>
                </div>

                <div class="quiz-card border-green" onclick="loadQ('./quizzes/geek.json')">
                    <h3>ğŸ‘¾ Geek</h3>
                    <p>Games e Tech</p>
                </div>

                <div class="quiz-card border-yellow" onclick="loadQ('./quizzes/familia.json')">
                    <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ FamÃ­lia</h3>
                    <p>Nosso Quiz</p>
                </div>
            </div>
        </div>

        <div id="screenControl" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div style="background:#333; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;">
                <span id="statusBar" style="font-weight:bold;">Aguardando...</span>
                <button onclick="changeQuiz()" style="font-size:0.8rem; padding:5px 10px; background:#555; border:1px solid #777; color:white; border-radius:4px; cursor:pointer;">Trocar</button>
            </div>
            
            <div class="admin-scroll" id="qList" style="background: #f0f2f5;"></div>

            <div style="padding:15px; background:white; border-top:1px solid #ddd; box-shadow: 0 -4px 10px rgba(0,0,0,0.05);">
                
                <button id="btnNextAction" onclick="updateState('lobby')" class="btn" style="background:#555; margin-bottom:10px; border:2px solid #333; font-weight:bold;">
                    ğŸ  Ir para o Lobby
                </button>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="updateState('leaderboard')" class="btn blue" style="margin:0; font-size:0.9rem;">ğŸ“Š Ranking</button>
                    <button onclick="updateState('podium')" class="btn yellow" style="margin:0; font-size:0.9rem;">ğŸ† PÃ³dio</button>
                </div>
                
                <div style="margin-top:10px;">
                    <button onclick="nuke()" class="btn red" style="margin:0; font-size:0.8rem; padding: 10px;">ğŸ—‘ï¸ Zerar Jogadores</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, update, get, set, onValue, off, keepScreenAwake, loadQuestions } from './game.js';

        let quizData = [];
        let timer = null;
        let qStartTime = 0;
        let isQuestionRunning = false;
        let playerListener = null;
        
        const sfx = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');
        keepScreenAwake();

        // 1. FUNÃ‡ÃƒO DE CARREGAR (Com Alerta de Erro)
        window.loadQ = async function(path) {
            sfx.play();
            try {
                // Tenta carregar
                quizData = await loadQuestions(path);
                
                // ValidaÃ§Ã£o
                if(!quizData || quizData.length === 0) {
                    alert(`ERRO: O arquivo "${path}" estÃ¡ vazio ou nÃ£o existe.\nVerifique a pasta 'quizzes'.`);
                    return;
                }

                // Renderiza BotÃµes
                const list = document.getElementById('qList');
                list.innerHTML = '';
                
                // CabeÃ§alho da lista
                const header = document.createElement('div');
                header.style.padding = "10px"; header.style.color="#666"; header.innerText = "Toque para lanÃ§ar:";
                list.appendChild(header);

                quizData.forEach((q, i) => {
                    const btn = document.createElement('button');
                    btn.id = `btnQ${i}`;
                    btn.className = 'btn';
                    btn.style.background = "white"; 
                    btn.style.color = "#333"; 
                    btn.style.textAlign = "left";
                    btn.style.marginBottom = "5px";
                    btn.style.boxShadow = "0 2px 2px rgba(0,0,0,0.1)";
                    btn.innerHTML = `<b style="color:#45a3e5">#${i+1}</b> ${q.text.substring(0,25)}...`;
                    btn.onclick = () => { sfx.play(); runQ(i); };
                    list.appendChild(btn);
                });

                // Troca Tela
                document.getElementById('screenSelection').classList.add('hidden');
                document.getElementById('screenControl').classList.remove('hidden');
                updateState('lobby');

            } catch (e) {
                alert("Erro grave ao carregar: " + e.message);
            }
        }

        window.changeQuiz = function() {
            if(confirm("Sair deste quiz?")) {
                document.getElementById('screenControl').classList.add('hidden');
                document.getElementById('screenSelection').classList.remove('hidden');
                updateState('lobby');
            }
        }

        window.updateState = (screen) => { 
            if(playerListener) { off(ref(db, 'players'), playerListener); playerListener = null; }
            if(timer) clearTimeout(timer);
            
            update(ref(db, 'gameState'), { screen: screen });

            const btn = document.getElementById('btnNextAction');
            if(screen === 'lobby') {
                btn.innerText = "â³ Aguardando Jogadores...";
                btn.style.background = "#555";
                btn.onclick = () => alert("Selecione uma pergunta da lista abaixo!");
            }
        }

        window.nuke = () => { if(confirm("Certeza? Isso apaga todos os pontos.")) set(ref(db, 'players'), {}); }

        window.runQ = async function(idx) {
             if(timer) clearTimeout(timer);
             if(playerListener) off(ref(db, 'players'), playerListener);
             
             isQuestionRunning = true; 
             qStartTime = Date.now();
             
             // Feedback Visual
             document.querySelectorAll('#qList button').forEach(b => b.style.background = "white");
             const currentBtn = document.getElementById(`btnQ${idx}`);
             if(currentBtn) currentBtn.style.background = "#e6f4ff";

             document.getElementById('statusBar').innerText = `Pergunta ${idx+1} rolando...`;

             // Reset Players
             const pSnap = await get(ref(db, 'players'));
             const updates = {};
             if(pSnap.exists()) pSnap.forEach(c => { 
                 updates[`players/${c.key}/lastAnswer`] = null; 
                 updates[`players/${c.key}/status`] = 'thinking'; 
                 updates[`players/${c.key}/answerTime`] = null; 
             });
             
             updates['gameState'] = { screen: 'question', currentQuestion: idx, showResult: false, endTime: qStartTime+20000 };
             await update(ref(db), updates);

             // Monitoramento
             playerListener = onValue(ref(db, 'players'), (snap) => {
                 if(!isQuestionRunning) return;
                 const ps = snap.val(); if(!ps) return;
                 let ans=0, tot=0;
                 Object.values(ps).forEach(p => { tot++; if(p.lastAnswer!=null) ans++; });
                 document.getElementById('statusBar').innerText = `Respondido: ${ans} / ${tot}`;
                 if(tot>0 && ans>=tot) finishQ(idx);
             });

             timer = setTimeout(() => { if(isQuestionRunning) finishQ(idx); }, 20000);
        }

        async function finishQ(idx) {
            if(!isQuestionRunning) return; 
            isQuestionRunning = false;
            if(playerListener) off(ref(db, 'players'), playerListener); clearTimeout(timer);
            
            const pSnap = await get(ref(db, 'players'));
            const correct = quizData[idx].correct;
            const updates = {};
            updates['gameState/showResult'] = true;

            if(pSnap.exists()) pSnap.forEach(c => {
                const p = c.val();
                if(p.lastAnswer === correct) {
                    const streak = (p.streak||0)+1;
                    let taken = (p.answerTime||(qStartTime+20000))-qStartTime;
                    if(taken<0)taken=0; if(taken>20000)taken=20000;
                    const pts = 500 + Math.floor(500*(1-(taken/20000))) + (streak>2?200:0);
                    updates[`players/${c.key}/score`] = (p.score||0)+pts; updates[`players/${c.key}/streak`] = streak; updates[`players/${c.key}/status`] = 'correct';
                } else {
                    updates[`players/${c.key}/streak`] = 0; updates[`players/${c.key}/status`] = 'wrong';
                }
            });
            await update(ref(db), updates);
            document.getElementById('statusBar').innerText = "Tempo Esgotado / Encerrado";
            
            // BotÃ£o PrÃ³xima Pergunta
            const nextIdx = idx+1;
            const btn = document.getElementById('btnNextAction');
            if(nextIdx < quizData.length) {
                btn.innerText = `â¡ï¸ LanÃ§ar Pergunta ${nextIdx+1}`;
                btn.onclick = () => { sfx.play(); runQ(nextIdx); };
                btn.style.background = "#26890c";
                const el = document.getElementById(`btnQ${nextIdx}`); 
                if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
            } else {
                btn.innerText = "ğŸ† Ir para PÃ³dio";
                btn.onclick = () => updateState('podium');
                btn.style.background = "#ffc00a"; btn.style.color="black";
            }
        }
    </script>
</body>
</html>