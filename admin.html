<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        
        <div id="screenSelection" style="padding: 20px;">
            <h2 style="margin-bottom:20px; color:#333;">ğŸ“‚ Escolha o Quiz</h2>
            
            <button onclick="loadQ('./quizzes/geral.json')" class="q-btn">
                ğŸŒ Conhecimentos Gerais
            </button>
            <button onclick="loadQ('./quizzes/familia.json')" class="q-btn">
                ğŸŒ FamÃ­lia
            </button>
            <button onclick="loadQ('./quizzes/geek.json')" class="q-btn">
                ğŸŒ Geek
            </button>			
             <button onclick="loadQ('./quizzes/series.json')" class="q-btn">
                ğŸ¬ SÃ©ries e Filmes
            </button>
             </div>

        <div id="screenControl" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            
            <div class="admin-header">
                <div>
                    <span id="statusBar" style="font-weight:bold; font-size:1.1rem;">Lobby</span>
                    <div style="font-size:0.8rem; opacity:0.8;">Painel de Controle</div>
                </div>
                <button onclick="location.reload()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:5px 10px; border-radius:5px;">Sair</button>
            </div>
            
            <div class="admin-scroll" id="qList"></div>

            <div class="admin-footer">
                
                <button id="btnNextAction" onclick="updateState('lobby')" class="btn btn-main" style="margin-bottom: 15px;">
                    ğŸ  Ir para Lobby
                </button>

                <div class="control-grid">
                    <button id="btnRank" onclick="toggleRanking()" class="btn btn-blue">ğŸ“Š Ranking</button>
                    <button onclick="updateState('podium')" class="btn btn-yellow">ğŸ† PÃ³dio</button>
                </div>
                
                <div class="control-grid" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;">
                     <button onclick="updateState('lobby')" class="btn" style="background: #6c757d; color: white;">
                        ğŸ”„ Reiniciar Jogo
                    </button>
                     <button onclick="nuke()" class="btn btn-red">
                        ğŸ—‘ï¸ Zerar Sala
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, update, get, set, onValue, off, keepScreenAwake, loadQuestions } from './game.js';

        let quizData = [];
        let timer = null;
        let qStartTime = 0;
        let isQuestionRunning = false;
        let isRankingOpen = false;
        let playerListener = null;
        const sfx = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');

        keepScreenAwake();

        window.loadQ = async function(path) {
            sfx.play();
            quizData = await loadQuestions(path);
            if(!quizData.length) return;

            const list = document.getElementById('qList');
            list.innerHTML = '';
            
            quizData.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.id = `btnQ${i}`;
                btn.className = 'q-btn'; 
                const shortText = q.text.length > 35 ? q.text.substring(0, 35) + '...' : q.text;
                btn.innerHTML = `<strong style="color:#007bff;">#${i+1}</strong> ${shortText}`;
                btn.onclick = () => { sfx.play(); runQ(i); };
                list.appendChild(btn);
            });

            document.getElementById('screenSelection').classList.add('hidden');
            document.getElementById('screenControl').classList.remove('hidden');
            updateState('lobby');
        }

        window.updateState = (screen) => { 
            if(playerListener) { off(ref(db, 'players'), playerListener); playerListener = null; }
            if(timer) clearTimeout(timer);
            isQuestionRunning = false;

            update(ref(db, 'gameState'), { screen: screen });

            // Atualiza BotÃ£o Principal
            const mainBtn = document.getElementById('btnNextAction');
            if(screen === 'lobby') {
                mainBtn.innerText = "â³ Aguardando no Lobby";
                mainBtn.className = "btn btn-main";
                mainBtn.onclick = () => alert("Selecione uma pergunta para comeÃ§ar!");
                isRankingOpen = false;
            } 
            else if (screen === 'leaderboard') isRankingOpen = true;
            else if (screen === 'podium') isRankingOpen = false;

            updateRankButtonUI();
        }

        window.toggleRanking = () => {
            sfx.play();
            if (isRankingOpen) {
                updateState('lobby');
                isRankingOpen = false;
            } else {
                updateState('leaderboard');
                isRankingOpen = true;
            }
            updateRankButtonUI();
        }

        function updateRankButtonUI() {
            const btn = document.getElementById('btnRank');
            if (isRankingOpen) {
                btn.innerText = "ğŸ”™ Voltar pro Jogo";
                btn.style.background = "#666";
            } else {
                btn.innerText = "ğŸ“Š Ver Ranking";
                btn.style.background = "#007bff";
            }
        }
        
        window.nuke = () => { if(confirm("Certeza que quer apagar todos?")) set(ref(db, 'players'), {}); }

        window.runQ = async function(idx) {
            if(timer) clearTimeout(timer);
            if(playerListener) off(ref(db, 'players'), playerListener);
            
            isQuestionRunning = true;
            isRankingOpen = false; 
            updateRankButtonUI();

            qStartTime = Date.now();
            const timeLimit = 30;

            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(`btnQ${idx}`);
            if(activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            document.getElementById('statusBar').innerText = `Pergunta ${idx+1}...`;

            const mainBtn = document.getElementById('btnNextAction');
            mainBtn.innerText = "ğŸ›‘ Encerrar Tempo Agora";
            mainBtn.className = "btn btn-red";
            mainBtn.onclick = () => finishQ(idx);

            // Reset Players
            const pSnap = await get(ref(db, 'players'));
            const updates = {};
            if(pSnap.exists()) {
                pSnap.forEach(c => { 
                    updates[`players/${c.key}/lastAnswer`] = null; 
                    updates[`players/${c.key}/status`] = 'thinking'; 
                    updates[`players/${c.key}/answerTime`] = null; 
                });
            }

            const currentQ = quizData[idx];
            updates['gameState'] = { 
                screen: 'question', 
                questionData: {
                    text: currentQ.text,
                    answers: currentQ.answers,
                    correct: currentQ.correct,
                    image: currentQ.image || null,
                    video: currentQ.video || null,
                    audio: currentQ.audio || null
                },
                showResult: false, 
                endTime: qStartTime+(timeLimit*1000) 
            };
            
            await update(ref(db), updates);

            const playersRef = ref(db, 'players');
            playerListener = onValue(playersRef, (snap) => {
                if(!isQuestionRunning) return;
                const players = snap.val();
                if(!players) { document.getElementById('statusBar').innerText = "0 Players"; return; }

                let answered = 0, total = 0;
                Object.values(players).forEach(p => {
                    total++;
                    if(p.lastAnswer !== undefined && p.lastAnswer !== null) answered++;
                });

                document.getElementById('statusBar').innerText = `Resp: ${answered} / ${total}`;
                if(total > 0 && answered >= total) finishQ(idx);
            });

            timer = setTimeout(() => { if(isQuestionRunning) finishQ(idx); }, timeLimit*1000);
        }

        async function finishQ(idx) {
            if(!isQuestionRunning) return;
            isQuestionRunning = false;
            if(playerListener) off(ref(db, 'players'), playerListener);
            if(timer) clearTimeout(timer);

            const pSnap = await get(ref(db, 'players'));
            const correct = quizData[idx].correct;
            const updates = {};
            
            updates['gameState/showResult'] = true;

            if(pSnap.exists()) pSnap.forEach(c => {
                const p = c.val();
                if(p.lastAnswer === correct) {
                    const streak = (p.streak||0) + 1;
                    let taken = (p.answerTime || (qStartTime+30000)) - qStartTime;
                    if(taken < 0) taken = 0; if(taken > 30000) taken = 30000;
                    
                    const bonus = Math.floor(500 * (1 - (taken/30000))); 
                    updates[`players/${c.key}/score`] = (p.score||0) + 500 + bonus + (streak>2?200:0);
                    updates[`players/${c.key}/streak`] = streak;
                    updates[`players/${c.key}/status`] = 'correct';
                } else {
                    updates[`players/${c.key}/streak`] = 0;
                    updates[`players/${c.key}/status`] = 'wrong';
                }
            });

            await update(ref(db), updates);
            document.getElementById('statusBar').innerText = "Resultado";
            
            const btnNext = document.getElementById('btnNextAction');
            if(idx + 1 < quizData.length) {
                btnNext.innerText = `â¡ï¸ PrÃ³xima: Pergunta ${idx + 2}`;
                btnNext.className = "btn btn-green";
                btnNext.style.backgroundColor = "#28a745";
                btnNext.onclick = () => { sfx.play(); runQ(idx + 1); };
            } else {
                btnNext.innerText = "ğŸ† Ir para PÃ³dio";
                btnNext.className = "btn btn-yellow";
                btnNext.onclick = () => updateState('podium');
            }
        }
    </script>
</body>
</html>