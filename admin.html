<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="admin-body">

    <div id="screenSelection" style="padding: 20px;">
        <h2 style="margin-bottom: 20px;">ðŸ“‚ Meus Quizzes</h2>
        <div onclick="loadQ('./quizzes/geral.json')" class="q-item">
            <div><i class="fas fa-brain"></i> Conhecimentos Gerais</div>
            <i class="fas fa-chevron-right"></i>
        </div>
        <div onclick="loadQ('./quizzes/series.json')" class="q-item">
            <div><i class="fas fa-film"></i> SÃ©ries e Filmes</div>
            <i class="fas fa-chevron-right"></i>
        </div>
    </div>

    <div id="screenControl" class="hidden" style="display:flex; flex-direction:column; height:100%;">
        
        <div class="admin-header">
            <h3 style="margin:0;"><i class="fas fa-gamepad"></i> Painel</h3>
            <button onclick="location.reload()" class="btn-modern btn-outline" style="width: auto; padding: 5px 15px; font-size:0.8rem;">
                <i class="fas fa-folder-open"></i> Trocar
            </button>
        </div>

        <div class="admin-content" id="qList">
            </div>

        <div class="admin-footer">
            
            <button onclick="forceFinish()" class="btn-modern btn-danger" style="grid-column: span 2; margin-bottom: 5px; background: #e17055;">
                <i class="fas fa-stopwatch"></i> ENCERRAR TEMPO AGORA
            </button>
            <button onclick="updateState('lobby')" class="btn-modern btn-dark">
                <i class="fas fa-home"></i> Lobby / PrÃ³x
            </button>
            
            <button onclick="updateState('leaderboard')" class="btn-modern btn-primary">
                <i class="fas fa-chart-bar"></i> Ranking
            </button>

            <button onclick="updateState('podium')" class="btn-modern btn-warning" style="grid-column: span 2;">
                <i class="fas fa-trophy"></i> PÃ“DIO FINAL
            </button>
            
            <button onclick="nuke()" class="btn-modern btn-outline" style="grid-column: span 2; margin-top:5px; opacity:0.7; border:1px solid #ff7675; color:#ff7675;">
                <i class="fas fa-trash"></i> Resetar Sala
            </button>
        </div>
    </div>

    <script type="module">
        import { db, ref, update, get, set, keepScreenAwake, loadQuestions } from './game.js';

        let quizData = [];
        let timer = null;
        let qStartTime = 0;
        let currentIdx = 0; // Armazena o Ã­ndice atual para poder forÃ§ar o fim
        
        const sfx = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');

        keepScreenAwake();

        window.loadQ = async function(path) {
            sfx.play();
            quizData = await loadQuestions(path);
            if(!quizData.length) return;

            const list = document.getElementById('qList');
            list.innerHTML = '';
            
            quizData.forEach((q, i) => {
                const item = document.createElement('div');
                item.className = 'q-item';
                item.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="q-number">#${i+1}</span>
                        <span style="font-size:0.9rem;">${q.text.substring(0,35)}...</span>
                    </div>
                    <i class="fas fa-play" style="color:#ddd;"></i>
                `;
                item.onclick = () => {
                    sfx.play();
                    Array.from(list.children).forEach(c => c.classList.remove('active'));
                    item.classList.add('active');
                    runQ(i);
                };
                list.appendChild(item);
            });

            document.getElementById('screenSelection').classList.add('hidden');
            document.getElementById('screenControl').classList.remove('hidden');
            updateState('lobby');
        }

        window.updateState = (screen) => { 
            sfx.play();
            update(ref(db, 'gameState'), { screen: screen }); 
        }
        
        window.nuke = () => { if(confirm("Tem certeza que quer expulsar todos?")) set(ref(db, 'players'), {}); }

        // --- FUNÃ‡ÃƒO PARA FORÃ‡AR O FIM DO TEMPO ---
        window.forceFinish = function() {
            if(timer) {
                console.log("Encerrando tempo manualmente...");
                clearTimeout(timer); // Para o relÃ³gio automÃ¡tico
                finishQ(currentIdx); // Chama a finalizaÃ§Ã£o imediatamente
            }
        }
        // -----------------------------------------

        window.runQ = async function(idx) {
            if(timer) clearTimeout(timer);
            
            currentIdx = idx; // Salva qual Ã© a pergunta atual
            qStartTime = Date.now();
            const timeLimit = 30; // 30 Segundos

            // Resetar Players
            const pSnap = await get(ref(db, 'players'));
            const updates = {};
            if(pSnap.exists()) pSnap.forEach(c => { 
                updates[`players/${c.key}/lastAnswer`] = null; 
                updates[`players/${c.key}/status`] = 'thinking'; 
                updates[`players/${c.key}/answerTime`] = null; 
            });
            
            updates['gameState'] = { 
                screen: 'question', 
                currentQuestion: idx, 
                showResult: false, 
                endTime: qStartTime+(timeLimit*1000) 
            };
            await update(ref(db), updates);

            // Inicia o timer automÃ¡tico
            timer = setTimeout(() => finishQ(idx), timeLimit*1000);
        }

        async function finishQ(idx) {
            // Garante que o timer seja limpo caso a funÃ§Ã£o seja chamada manualmente
            if(timer) clearTimeout(timer);
            timer = null;

            const pSnap = await get(ref(db, 'players'));
            const correct = quizData[idx].correct;
            const updates = {};
            updates['gameState/showResult'] = true;

            if(pSnap.exists()) pSnap.forEach(c => {
                const p = c.val();
                if(p.lastAnswer === correct) {
                    const streak = (p.streak||0) + 1;
                    
                    // CÃ¡lculo de bÃ´nus por tempo (baseado em 30s)
                    let taken = (p.answerTime || (qStartTime+30000)) - qStartTime;
                    if(taken < 0) taken = 0; 
                    if(taken > 30000) taken = 30000;
                    
                    const bonus = Math.floor(500 * (1 - (taken/30000)));
                    updates[`players/${c.key}/score`] = (p.score||0) + 500 + bonus + (streak>2?200:0);
                    updates[`players/${c.key}/streak`] = streak;
                    updates[`players/${c.key}/status`] = 'correct';
                } else {
                    updates[`players/${c.key}/streak`] = 0;
                    updates[`players/${c.key}/status`] = 'wrong';
                }
            });
            await update(ref(db), updates);
        }
    </script>
</body>
</html>