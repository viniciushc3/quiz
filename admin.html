<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        
        <div id="screenSelection" style="padding: 20px;">
            <h2 style="margin-bottom:20px; color:#333;">ğŸ“‚ Escolha o Quiz</h2>
            <button onclick="loadQ('./quizzes/geral.json')" class="btn btn-main" style="margin-bottom:15px; text-align:left; justify-content: flex-start;">ğŸŒ Conhecimentos Gerais</button>
            <button onclick="loadQ('./quizzes/series.json')" class="btn btn-main" style="margin-bottom:15px; text-align:left; justify-content: flex-start;">ğŸ¬ SÃ©ries e Filmes</button>
            </div>

        <div id="screenControl" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            
            <div class="admin-header">
                <div>
                    <span id="statusBar" style="font-weight:bold; font-size:1.1rem;">Lobby</span>
                    <div style="font-size:0.8rem; opacity:0.8;">Painel de Controle</div>
                </div>
                <button onclick="location.reload()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:5px 10px; border-radius:5px;">Sair</button>
            </div>
            
            <div class="admin-scroll" id="qList"></div>

            <div class="admin-footer">
                
                <button id="btnNextAction" onclick="updateState('lobby')" class="btn btn-main">
                    ğŸ  Ir para Lobby
                </button>

                <div class="control-grid">
                    <button id="btnRank" onclick="toggleRanking()" class="btn btn-blue">ğŸ“Š Ranking</button>
                    <button onclick="updateState('podium')" class="btn btn-yellow">ğŸ† PÃ³dio Final</button>
                </div>
                
                <div style="margin-top: 10px;">
                     <button onclick="nuke()" class="btn btn-red" style="padding: 10px; font-size: 0.9rem;">ğŸ—‘ï¸ Zerar Sala</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, update, get, set, onValue, off, keepScreenAwake, loadQuestions } from './game.js';

        let quizData = [];
        let timer = null;
        let qStartTime = 0;
        let currentIdx = -1; // Guarda o Ã­ndice atual
        let isQuestionRunning = false;
        let isRankingOpen = false; // Controle do Toggle
        let playerListener = null;
        const sfx = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');

        keepScreenAwake();

        window.loadQ = async function(path) {
            sfx.play();
            quizData = await loadQuestions(path);
            if(!quizData.length) return;

            const list = document.getElementById('qList');
            list.innerHTML = '';
            
            quizData.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.id = `btnQ${i}`;
                btn.className = 'q-btn'; 
                const shortText = q.text.length > 35 ? q.text.substring(0, 35) + '...' : q.text;
                btn.innerHTML = `<strong style="color:#007bff;">#${i+1}</strong> ${shortText}`;
                btn.onclick = () => { sfx.play(); runQ(i); };
                list.appendChild(btn);
            });

            document.getElementById('screenSelection').classList.add('hidden');
            document.getElementById('screenControl').classList.remove('hidden');
            updateState('lobby');
        }

        window.updateState = (screen) => { 
            // Limpa listeners antigos
            if(playerListener) { off(ref(db, 'players'), playerListener); playerListener = null; }
            if(timer) clearTimeout(timer);
            isQuestionRunning = false;

            update(ref(db, 'gameState'), { screen: screen });

            // Atualiza BotÃ£o Principal baseando-se na tela
            const mainBtn = document.getElementById('btnNextAction');
            
            if(screen === 'lobby') {
                mainBtn.innerText = "â³ Aguardando no Lobby";
                mainBtn.className = "btn btn-main";
                mainBtn.onclick = () => alert("Selecione uma pergunta da lista para comeÃ§ar!");
                isRankingOpen = false; // Reseta toggle
            } 
            else if (screen === 'leaderboard') {
                isRankingOpen = true; // Marca que tÃ¡ aberto
            }
            else if (screen === 'podium') {
                isRankingOpen = false;
            }

            updateRankButtonUI(); // Atualiza texto do botÃ£o ranking
        }

        // --- LÃ“GICA DE TOGGLE DO RANKING ---
        window.toggleRanking = () => {
            sfx.play();
            if (isRankingOpen) {
                // Se jÃ¡ estÃ¡ aberto, volta pro Lobby (para preparar prox pergunta)
                updateState('lobby');
                isRankingOpen = false;
            } else {
                // Se nÃ£o estÃ¡ aberto, abre
                updateState('leaderboard');
                isRankingOpen = true;
            }
            updateRankButtonUI();
        }

        function updateRankButtonUI() {
            const btn = document.getElementById('btnRank');
            if (isRankingOpen) {
                btn.innerText = "ğŸ”™ Voltar pro Jogo";
                btn.style.background = "#666"; // Cor cinza para indicar 'voltar'
            } else {
                btn.innerText = "ğŸ“Š Ver Ranking";
                btn.style.background = "#007bff"; // Azul original
            }
        }
        
        window.nuke = () => { if(confirm("Certeza que quer apagar todos?")) set(ref(db, 'players'), {}); }

        // --- RODAR PERGUNTA ---
        window.runQ = async function(idx) {
            if(timer) clearTimeout(timer);
            if(playerListener) off(ref(db, 'players'), playerListener);
            
            currentIdx = idx;
            isQuestionRunning = true;
            isRankingOpen = false; // Pergunta fecha o ranking
            updateRankButtonUI();

            qStartTime = Date.now();
            const timeLimit = 30;

            // Highlight visual
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(`btnQ${idx}`);
            if(activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            document.getElementById('statusBar').innerText = `Pergunta ${idx+1} rolando...`;

            // CONFIGURA BOTÃƒO PARA "ENCERRAR MANUALMENTE"
            const mainBtn = document.getElementById('btnNextAction');
            mainBtn.innerText = "ğŸ›‘ Encerrar Tempo Agora";
            mainBtn.className = "btn btn-red"; // Vermelho
            mainBtn.onclick = () => finishQ(idx); // Clicar encerra manualmente

            // Resetar Players
            const pSnap = await get(ref(db, 'players'));
            const updates = {};
            if(pSnap.exists()) {
                pSnap.forEach(c => { 
                    updates[`players/${c.key}/lastAnswer`] = null; 
                    updates[`players/${c.key}/status`] = 'thinking'; 
                    updates[`players/${c.key}/answerTime`] = null; 
                });
            }

            const currentQ = quizData[idx];
            updates['gameState'] = { 
                screen: 'question', 
                questionData: {
                    text: currentQ.text,
                    answers: currentQ.answers,
                    correct: currentQ.correct,
                    image: currentQ.image || null,
                    video: currentQ.video || null,
                    audio: currentQ.audio || null
                },
                showResult: false, 
                endTime: qStartTime+(timeLimit*1000) 
            };
            
            await update(ref(db), updates);

            // MONITORAMENTO (AUTO-STOP)
            const playersRef = ref(db, 'players');
            playerListener = onValue(playersRef, (snap) => {
                if(!isQuestionRunning) return;
                const players = snap.val();
                
                // Se nÃ£o tem players, nÃ£o faz nada
                if(!players) {
                    document.getElementById('statusBar').innerText = "0 Jogadores";
                    return;
                }

                let answered = 0, total = 0;
                Object.values(players).forEach(p => {
                    total++;
                    if(p.lastAnswer !== undefined && p.lastAnswer !== null) answered++;
                });

                document.getElementById('statusBar').innerText = `Respondido: ${answered} / ${total}`;
                
                // LÃ“GICA DE ENCERRAMENTO AUTOMÃTICO
                if(total > 0 && answered >= total) {
                    console.log("Todos responderam. Encerrando...");
                    finishQ(idx);
                }
            });

            // Timer de seguranÃ§a (caso alguÃ©m caia e nÃ£o responda)
            timer = setTimeout(() => { if(isQuestionRunning) finishQ(idx); }, timeLimit*1000);
        }

        async function finishQ(idx) {
            // Evita rodar duas vezes
            if(!isQuestionRunning) return;
            isQuestionRunning = false;
            
            if(playerListener) off(ref(db, 'players'), playerListener);
            if(timer) clearTimeout(timer);

            const pSnap = await get(ref(db, 'players'));
            const correct = quizData[idx].correct;
            const updates = {};
            
            updates['gameState/showResult'] = true;

            if(pSnap.exists()) pSnap.forEach(c => {
                const p = c.val();
                if(p.lastAnswer === correct) {
                    const streak = (p.streak||0) + 1;
                    let taken = (p.answerTime || (qStartTime+30000)) - qStartTime;
                    if(taken < 0) taken = 0; if(taken > 30000) taken = 30000;
                    
                    const bonus = Math.floor(500 * (1 - (taken/30000))); 
                    updates[`players/${c.key}/score`] = (p.score||0) + 500 + bonus + (streak>2?200:0);
                    updates[`players/${c.key}/streak`] = streak;
                    updates[`players/${c.key}/status`] = 'correct';
                } else {
                    updates[`players/${c.key}/streak`] = 0;
                    updates[`players/${c.key}/status`] = 'wrong';
                }
            });

            await update(ref(db), updates);
            document.getElementById('statusBar').innerText = "Resultado na Tela";
            
            // CONFIGURA BOTÃƒO PARA "PRÃ“XIMA PERGUNTA"
            const btnNext = document.getElementById('btnNextAction');
            
            if(idx + 1 < quizData.length) {
                btnNext.innerText = `â¡ï¸ PrÃ³xima: Pergunta ${idx + 2}`;
                btnNext.className = "btn btn-green"; // Estilo verde (adicione no CSS ou use style inline)
                btnNext.style.backgroundColor = "#28a745"; // ForÃ§a verde
                btnNext.onclick = () => { sfx.play(); runQ(idx + 1); };
            } else {
                btnNext.innerText = "ğŸ† Fim do Quiz! Ir para PÃ³dio";
                btnNext.className = "btn btn-yellow";
                btnNext.onclick = () => updateState('podium');
            }
        }
    </script>
</body>
</html>