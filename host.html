<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>TV Principal</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
    <button id="btnSound" style="position:absolute; top:10px; left:10px; z-index:999; padding:8px 15px; border-radius:50px; background:rgba(255,255,255,0.2); border:1px solid white; color:white; cursor:pointer; font-weight:bold;">ğŸ”‡ Som</button>
    
    <div id="lobby" class="host-container">
        <h1 style="font-size:3.5rem; margin-bottom:10px;">Entrem no Jogo!</h1>
        <img id="qrCode" src="" style="border: 8px solid white; border-radius: 15px; margin: 10px; width: 250px;">
        <h2 id="joinUrl" style="background:rgba(255,255,255,0.1); padding:10px 30px; border-radius:50px; font-family: monospace;"></h2>
        <div style="margin-top:20px; width: 100%;">
            <h3>Jogadores (<span id="count">0</span>):</h3>
            <div id="playerList" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-width:900px; margin: 0 auto;"></div>
        </div>
    </div>

    <div id="game" class="host-container hidden">
        <div id="timerCircle"></div>
        <div class="media-box hidden" id="mediaContainer" style="display:flex; justify-content:center; width:100%; margin-bottom:10px;">
            <img id="qImg" class="hidden" style="max-height:35vh; border-radius:10px; border:4px solid white;">
            <video id="qVid" class="hidden" style="max-height:35vh; border-radius:10px;" loop playsinline></video>
            <audio id="qAud"></audio>
        </div>
        <h1 id="questionText">Aguardando...</h1>
        <div class="answers-grid" id="ansGrid">
            <div class="ans-card red" id="opt0"><span class="ans-text">A</span><div class="result-bar" id="bar0"></div><div class="vote-count" id="count0">0</div></div>
            <div class="ans-card blue" id="opt1"><span class="ans-text">B</span><div class="result-bar" id="bar1"></div><div class="vote-count" id="count1">0</div></div>
            <div class="ans-card yellow" id="opt2"><span class="ans-text">C</span><div class="result-bar" id="bar2"></div><div class="vote-count" id="count2">0</div></div>
            <div class="ans-card green" id="opt3"><span class="ans-text">D</span><div class="result-bar" id="bar3"></div><div class="vote-count" id="count3">0</div></div>
        </div>
    </div>

    <div id="leaderboard" class="host-container hidden" style="background:#2c3e50;">
        <h1 style="font-size:3.5rem; margin-bottom:30px;">ğŸ“ˆ Top 5</h1>
        <div id="leaderboardList" style="width:80%; max-width:600px;"></div>
    </div>

    <div id="podium" class="host-container hidden" style="background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);">
        <h1>ğŸ† Vencedores ğŸ†</h1>
        <div class="podium-stage">
            <div class="podium-bar" id="p2Box" style="width:20%; height:50%; background:#c0c0c0; opacity:0;">
                <div id="p2Name" style="font-weight:bold; margin-bottom:10px;"></div><div style="font-size:3rem;">2Âº</div><div id="p2Score" style="background:rgba(0,0,0,0.3); padding:5px; border-radius:10px;">0</div>
            </div>
            <div class="podium-bar" id="p1Box" style="width:25%; height:70%; background:#ffd700; opacity:0;">
                <div style="font-size:4rem;">ğŸ‘‘</div><div id="p1Name" style="font-weight:bold; font-size:1.8rem; margin-bottom:10px;"></div><div style="font-size:5rem; line-height:1;">1Âº</div><div id="p1Score" style="background:rgba(0,0,0,0.3); padding:5px; border-radius:10px;">0</div>
            </div>
            <div class="podium-bar" id="p3Box" style="width:20%; height:40%; background:#cd7f32; opacity:0;">
                <div id="p3Name" style="font-weight:bold; margin-bottom:10px;"></div><div style="font-size:3rem;">3Âº</div><div id="p3Score" style="background:rgba(0,0,0,0.3); padding:5px; border-radius:10px;">0</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, onValue, keepScreenAwake } from './game.js';

        let playersList = []; // Lista Global de Jogadores
        let timerInt = null;
        let audioOn = false;

        const tracks = {
            lobby: new Audio('https://www.soundjay.com/misc/sounds/dream-harp-02.mp3'),
            think: new Audio('https://www.soundjay.com/clock/sounds/clock-ticking-2.mp3'),
            win: new Audio('https://www.soundjay.com/human/sounds/applause-01.mp3'),
            fail: new Audio('https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3'),
            podium: new Audio('https://www.soundjay.com/music/sounds/music-box-01.mp3')
        };
        tracks.lobby.loop = true; tracks.think.loop = true;

        const Jukebox = {
            curr: null,
            play: function(key) {
                if(!audioOn) return;
                try {
                    if(this.curr && this.curr !== tracks[key]) { this.curr.pause(); this.curr.currentTime=0; }
                    if(tracks[key]) { this.curr = tracks[key]; this.curr.play().catch(e => console.log("Audio block")); }
                } catch(e){}
            },
            stop: function() { if(this.curr) { this.curr.pause(); this.curr = null; } }
        };

        document.getElementById('btnSound').onclick = function() {
            audioOn = !audioOn;
            this.innerText = audioOn ? "ğŸ”Š Som ON" : "ğŸ”‡ Som OFF";
            if(audioOn && !document.getElementById('lobby').classList.contains('hidden')) Jukebox.play('lobby');
            else if(!audioOn) Jukebox.stop();
        };

        keepScreenAwake();

        const url = window.location.href.replace('host.html', 'player.html');
        document.getElementById('joinUrl').innerText = url;
        document.getElementById('qrCode').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}`;

        // ==========================================
        // 1. MONITORAMENTO DE JOGADORES (CorreÃ§Ã£o)
        // ==========================================
        onValue(ref(db, 'players'), (snap) => {
            const list = document.getElementById('playerList');
            playersList = []; // Zera a lista global
            list.innerHTML = ''; // Limpa visual do lobby

            snap.forEach(c => {
                playersList.push(c.val());
            });

            // Ordena sempre do maior para o menor (Converte para int para garantir)
            playersList.sort((a,b) => (parseInt(b.score) || 0) - (parseInt(a.score) || 0));
            
            // Debug para vocÃª ver no console (Aperte F12 na TV)
            console.log("Jogadores atualizados:", playersList.length, playersList);

            document.getElementById('count').innerText = playersList.length;

            // Renderiza Lobby
            playersList.forEach(p => {
                const el = document.createElement('div');
                el.style.cssText = "background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:20px; font-weight:bold; display:flex; align-items:center; gap:5px;";
                el.innerText = `${p.avatar||'ğŸ‘¤'} ${p.name}`;
                list.appendChild(el);
            });

            // Se estivermos em telas de ranking, atualiza em tempo real
            const st = document.querySelector('.host-container:not(.hidden)');
            if(st && st.id === 'leaderboard') renderLeaderboard();
            if(st && st.id === 'podium') renderPodium();
        });

        // ==========================================
        // 2. FUNÃ‡Ã•ES DE RENDERIZAÃ‡ÃƒO SEPARADAS
        // ==========================================
        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            // Pega top 5
            playersList.slice(0,5).forEach((p, i) => {
                const row = document.createElement('div');
                row.className = 'leaderboard-row';
                // AnimaÃ§Ã£o leve
                setTimeout(() => row.style.opacity = 1, i * 100); 
                row.innerHTML = `<div>#${i+1} ${p.avatar||''} ${p.name}</div><div>${p.score}</div>`;
                list.appendChild(row);
            });
        }

        function renderPodium() {
            const top = playersList.slice(0, 3);
            
            const fill = (idx, idPrefix) => {
                const p = top[idx];
                const box = document.getElementById(idPrefix+'Box');
                
                if(p) {
                    box.style.opacity = "1"; // Mostra
                    document.getElementById(idPrefix+'Name').innerText = `${p.avatar || ''} ${p.name}`;
                    document.getElementById(idPrefix+'Score').innerText = p.score || 0;
                } else {
                    box.style.opacity = "0"; // Esconde suavemente se nÃ£o existir
                }
            }
            fill(0, 'p1'); // 1Âº
            fill(1, 'p2'); // 2Âº
            fill(2, 'p3'); // 3Âº
        }

        // ==========================================
        // 3. ESTADO DO JOGO
        // ==========================================
        onValue(ref(db, 'gameState'), (snap) => {
            const st = snap.val();
            if(!st) return;

            // Esconde tudo
            ['lobby', 'game', 'leaderboard', 'podium'].forEach(id => document.getElementById(id).classList.add('hidden'));

            if(st.screen === 'lobby') {
                document.getElementById('lobby').classList.remove('hidden');
                Jukebox.play('lobby');
                clearInterval(timerInt);
            }
            else if(st.screen === 'question') {
                document.getElementById('game').classList.remove('hidden');
                
                const q = st.questionData; 
                if(!q) return; // SeguranÃ§a

                document.getElementById('questionText').innerText = q.text;

                // MÃ­dia
                const box = document.getElementById('mediaContainer');
                const img = document.getElementById('qImg');
                const vid = document.getElementById('qVid');
                const aud = document.getElementById('qAud');
                
                img.classList.add('hidden'); vid.classList.add('hidden'); vid.pause(); aud.pause(); box.classList.add('hidden');

                if(q.image) { box.classList.remove('hidden'); img.src = q.image; img.classList.remove('hidden'); }
                else if(q.video) { box.classList.remove('hidden'); vid.src = q.video; vid.classList.remove('hidden'); if(audioOn) vid.play(); }
                else if(q.audio) { box.classList.remove('hidden'); img.src = "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjEx.../music_icon.gif"; img.classList.remove('hidden'); aud.src = q.audio; if(audioOn) aud.play(); }

                // Grid
                const grid = document.getElementById('ansGrid');
                if(q.answers && q.answers.length === 2) {
                    grid.classList.add('two-options');
                    document.getElementById('opt2').classList.add('hidden');
                    document.getElementById('opt3').classList.add('hidden');
                } else {
                    grid.classList.remove('two-options');
                    document.getElementById('opt2').classList.remove('hidden');
                    document.getElementById('opt3').classList.remove('hidden');
                }

                // OpÃ§Ãµes
                if(q.answers) {
                    q.answers.forEach((ans, i) => {
                        const el = document.getElementById(`opt${i}`);
                        if(el) {
                            el.querySelector('.ans-text').innerText = ans;
                            el.style.opacity = "1"; el.style.filter = "none"; el.style.border = "none";
                            document.getElementById(`bar${i}`).style.height = "0";
                            const cnt = document.getElementById(`count${i}`);
                            if(cnt) { cnt.innerText = "0"; cnt.style.opacity = "0"; }
                        }
                    });
                }

                if(st.endTime && !st.showResult) {
                    Jukebox.play('think');
                    startTimer(st.endTime);
                } else if(st.showResult) {
                    clearInterval(timerInt);
                    document.getElementById('timerCircle').innerText = "0";
                    vid.pause(); aud.pause();

                    const votes = [0,0,0,0];
                    let total = 0;
                    playersList.forEach(p => { if(p.lastAnswer!=null) { votes[p.lastAnswer]++; total++; }});

                    const correctVotes = votes[q.correct];
                    Jukebox.play(correctVotes > 0 ? 'win' : 'fail');

                    q.answers.forEach((_, i) => {
                        const bar = document.getElementById(`bar${i}`);
                        const count = document.getElementById(`count${i}`);
                        const el = document.getElementById(`opt${i}`);
                        
                        if(count) { count.innerText = votes[i]; count.style.opacity = "1"; }
                        if(bar) bar.style.height = total > 0 ? (votes[i]/total)*100 + "%" : "0";

                        if(i !== q.correct) { el.style.opacity = "0.5"; el.style.filter = "grayscale(1)"; }
                        else { el.style.border = "5px solid white"; }
                    });
                }
            }
            // RANKING (ForÃ§a renderizaÃ§Ã£o ao entrar)
            else if(st.screen === 'leaderboard') {
                document.getElementById('leaderboard').classList.remove('hidden');
                Jukebox.play('lobby');
                renderLeaderboard(); // CHAMA EXPLÃCITO AQUI
            }
            // PÃ“DIO (ForÃ§a renderizaÃ§Ã£o ao entrar)
            else if(st.screen === 'podium') {
                document.getElementById('podium').classList.remove('hidden');
                Jukebox.play('podium');
                renderPodium(); // CHAMA EXPLÃCITO AQUI
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
        });

        function startTimer(end) {
            if(timerInt) clearInterval(timerInt);
            const tm = document.getElementById('timerCircle');
            timerInt = setInterval(() => {
                const left = Math.ceil((end - Date.now())/1000);
                if(left<=0) { tm.innerText="0"; clearInterval(timerInt); }
                else { tm.innerText = left; if(left<=5) tm.classList.add('hurry'); else tm.classList.remove('hurry'); }
            }, 500);
        }
    </script>
</body>
</html>