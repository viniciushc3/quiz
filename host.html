<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>TV - Host</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
    <button id="btnSound" style="position:absolute; top:10px; left:10px; z-index:999; padding:10px; border-radius:5px; background:rgba(255,255,255,0.2); border:1px solid white; color:white; cursor:pointer;">ğŸ”‡ Som Off</button>
    
    <div id="lobby" class="host-container">
        <h1 style="font-size:3.5rem;">Entrem no Jogo!</h1>
        <img id="qrCode" src="" style="border: 8px solid white; border-radius: 15px; margin: 10px;">
        <h2 id="joinUrl" style="background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:50px;"></h2>
        <div style="margin-top:20px; width:100%;">
            <h3>Jogadores (<span id="count">0</span>):</h3>
            <div id="playerList" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-width:900px; margin:0 auto;"></div>
        </div>
    </div>

    <div id="game" class="host-container hidden">
        <div id="timerCircle">20</div>
        
        <div class="media-box hidden" id="mediaContainer" style="display:flex; justify-content:center; width:100%;">
            <img id="qImg" class="hidden" style="max-height:35vh;">
            <video id="qVid" class="hidden" style="max-height:35vh;" loop playsinline></video>
            <audio id="qAud"></audio>
        </div>

        <h1 id="questionText">Aguardando pergunta...</h1>
        
        <div class="answers-grid" id="ansGrid">
            <div class="ans-card red" id="opt0"><span class="ans-text">A</span><div class="result-bar" id="bar0"></div><div class="vote-count" id="count0">0</div></div>
            <div class="ans-card blue" id="opt1"><span class="ans-text">B</span><div class="result-bar" id="bar1"></div><div class="vote-count" id="count1">0</div></div>
            <div class="ans-card yellow" id="opt2"><span class="ans-text">C</span><div class="result-bar" id="bar2"></div><div class="vote-count" id="count2">0</div></div>
            <div class="ans-card green" id="opt3"><span class="ans-text">D</span><div class="result-bar" id="bar3"></div><div class="vote-count" id="count3">0</div></div>
        </div>
    </div>

    <div id="leaderboard" class="host-container hidden" style="background:#2c3e50;">
        <h1 style="font-size:3.5rem;">ğŸ“ˆ Top 5</h1>
        <div id="leaderboardList" style="width:80%; max-width:600px;"></div>
    </div>

    <div id="podium" class="host-container hidden" style="background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);">
        <h1>ğŸ† Vencedores ğŸ†</h1>
        <div class="podium-stage">
            <div class="podium-bar" id="p2Box" style="width:20%; height:50%; background:#c0c0c0; visibility:hidden;">
                <div id="p2Name" style="font-weight:bold;"></div><div style="font-size:3rem;">2Âº</div><div id="p2Score">0</div>
            </div>
            <div class="podium-bar" id="p1Box" style="width:25%; height:70%; background:#ffd700; visibility:hidden;">
                <div style="font-size:4rem;">ğŸ‘‘</div><div id="p1Name" style="font-weight:bold; font-size:1.5rem;"></div><div style="font-size:5rem; line-height:1;">1Âº</div><div id="p1Score">0</div>
            </div>
            <div class="podium-bar" id="p3Box" style="width:20%; height:40%; background:#cd7f32; visibility:hidden;">
                <div id="p3Name" style="font-weight:bold;"></div><div style="font-size:3rem;">3Âº</div><div id="p3Score">0</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, onValue, keepScreenAwake } from './game.js?v=4';

        let playersList = [];
        let timerInt = null;
        let audioOn = false;

        const tracks = { lobby: new Audio('https://www.soundjay.com/misc/sounds/dream-harp-02.mp3'), think: new Audio('https://www.soundjay.com/clock/sounds/clock-ticking-2.mp3'), win: new Audio('https://www.soundjay.com/human/sounds/applause-01.mp3'), fail: new Audio('https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3'), podium: new Audio('https://www.soundjay.com/music/sounds/music-box-01.mp3') };
        tracks.lobby.loop = true; tracks.think.loop = true;
        
        const Jukebox = { curr: null, play: function(k){ if(!audioOn)return; if(this.curr&&this.curr!==tracks[k]){this.curr.pause();this.curr.currentTime=0;} if(tracks[k]){this.curr=tracks[k];this.curr.play().catch(()=>{});}}, stop: function(){if(this.curr){this.curr.pause();this.curr=null;}} };
        document.getElementById('btnSound').onclick = function() { audioOn=!audioOn; this.innerText=audioOn?"ğŸ”Š Som ON":"ğŸ”‡ Som OFF"; if(audioOn&&!document.getElementById('lobby').classList.contains('hidden')) Jukebox.play('lobby'); else if(!audioOn) Jukebox.stop(); };

        keepScreenAwake();
        
        const url = window.location.href.replace('host.html', 'player.html');
        document.getElementById('joinUrl').innerText = url;
        document.getElementById('qrCode').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}`;

        // --- MONITORAR LISTA DE JOGADORES ---
        onValue(ref(db, 'players'), (snap) => {
            const list = document.getElementById('playerList');
            playersList = []; list.innerHTML = '';
            const raw = snap.val();
            if(raw) Object.values(raw).forEach(p => playersList.push(p));
            playersList.sort((a,b) => (b.score||0) - (a.score||0));
            document.getElementById('count').innerText = playersList.length;
            playersList.forEach(p => {
                const el = document.createElement('div');
                el.style.cssText = "background:rgba(255,255,255,0.2); color:white; padding:8px 15px; border-radius:20px; font-weight:bold; font-size:1.1rem; animation:popIn 0.3s;";
                el.innerText = `${p.avatar||'ğŸ‘¤'} ${p.name} (${p.score||0})`;
                list.appendChild(el);
            });
        });

        // --- MONITORAR ESTADO DO JOGO ---
        onValue(ref(db, 'gameState'), (snap) => {
            const st = snap.val();
            if(!st) return;

            ['lobby', 'game', 'leaderboard', 'podium'].forEach(id => document.getElementById(id).classList.add('hidden'));

            if(st.screen === 'lobby') {
                document.getElementById('lobby').classList.remove('hidden');
                Jukebox.play('lobby'); clearInterval(timerInt);
            }
            else if(st.screen === 'question') {
                document.getElementById('game').classList.remove('hidden');

                // 1. ATUALIZA TEXTOS (Recebidos do Admin)
                document.getElementById('questionText').innerText = st.qText || "Pergunta...";
                
                // MÃ­dia
                const box=document.getElementById('mediaContainer'), img=document.getElementById('qImg'), vid=document.getElementById('qVid'), aud=document.getElementById('qAud');
                img.classList.add('hidden'); vid.classList.add('hidden'); aud.pause(); box.classList.add('hidden');
                if(st.qImage){box.classList.remove('hidden');img.src=st.qImage;img.classList.remove('hidden');}
                else if(st.qVideo){box.classList.remove('hidden');vid.src=st.qVideo;vid.classList.remove('hidden');if(audioOn)vid.play();}

                // 2. ATUALIZA OPÃ‡Ã•ES
                const answers = st.qAnswers || ["A","B","C","D"];
                answers.forEach((ans, i) => {
                    const el = document.getElementById(`opt${i}`);
                    if(el) {
                        el.querySelector('.ans-text').innerText = ans;
                        el.style.opacity = "1"; el.style.filter = "none"; el.style.border = "none";
                        document.getElementById(`bar${i}`).style.height = "0";
                        document.getElementById(`count${i}`).style.opacity = "0";
                    }
                });

                // 3. LÃ“GICA DO TIMER E RESULTADO
                if(st.endTime && !st.showResult) {
                    Jukebox.play('think'); 
                    runTimer(st.endTime);
                } else if(st.showResult) {
                    clearInterval(timerInt); 
                    document.getElementById('timerCircle').innerText="0"; 
                    vid.pause();
                    
                    // Contagem de votos
                    const votes=[0,0,0,0]; let total=0;
                    playersList.forEach(p=>{ if(p.lastAnswer!=null && p.lastAnswer!==undefined){ votes[p.lastAnswer]++; total++; } });
                    
                    const correctIndex = st.qCorrect;
                    Jukebox.play((votes[correctIndex]>0 && total>0) ? 'win' : 'fail');

                    answers.forEach((_, i) => {
                        const bar=document.getElementById(`bar${i}`), count=document.getElementById(`count${i}`), el=document.getElementById(`opt${i}`);
                        if(bar) {
                            count.innerText=votes[i]; count.style.opacity="1";
                            bar.style.height = total>0 ? (votes[i]/total)*100+"%" : "0";
                            if(i !== correctIndex){ el.style.opacity="0.5"; el.style.filter="grayscale(1)"; } 
                            else { el.style.border="5px solid white"; }
                        }
                    });
                }
            }
            // ... (Resto igual: Leaderboard e Podium) ...
            else if(st.screen === 'leaderboard') {
                document.getElementById('leaderboard').classList.remove('hidden');
                Jukebox.play('lobby');
                const list = document.getElementById('leaderboardList'); list.innerHTML='';
                playersList.slice(0,5).forEach((p, i) => {
                    const r=document.createElement('div'); r.className='leaderboard-row'; r.style.animationDelay=(i*0.1)+'s';
                    r.innerHTML=`<div>#${i+1} ${p.avatar} ${p.name}</div><div>${p.score}</div>`; list.appendChild(r);
                });
            }
            else if(st.screen === 'podium') {
                document.getElementById('podium').classList.remove('hidden');
                Jukebox.play('podium');
                const fill=(idx,id)=>{
                    const p=playersList[idx]; const b=document.getElementById(id+'Box');
                    if(p){ b.style.visibility='visible'; document.getElementById(id+'Name').innerText=`${p.avatar} ${p.name}`; document.getElementById(id+'Score').innerText=p.score; }
                    else{ b.style.visibility='hidden'; }
                };
                fill(0,'p1'); fill(1,'p2'); fill(2,'p3');
                confetti({particleCount:150,spread:70,origin:{y:0.6}});
            }
        });

        // FUNÃ‡ÃƒO TIMER ROBUSTA
        function runTimer(endTime) {
            if(timerInt) clearInterval(timerInt);
            const el = document.getElementById('timerCircle');
            
            const tick = () => {
                const now = Date.now();
                const diff = Math.ceil((endTime - now) / 1000);
                
                if (diff <= 0) {
                    el.innerText = "0";
                    clearInterval(timerInt);
                } else {
                    el.innerText = diff;
                    if(diff <= 5) el.classList.add('hurry');
                    else el.classList.remove('hurry');
                }
            };
            
            tick(); // Executa na hora
            timerInt = setInterval(tick, 500); // Repete a cada 0.5s
        }
    </script>
</body>
</html>