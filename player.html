<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jogador</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <audio id="clickSfx" src="https://www.soundjay.com/buttons/sounds/button-30.mp3"></audio>

    <div id="loginScreen" class="player-container" style="justify-content:center;">
        <h1 style="font-size:3rem; margin-bottom:10px;">ðŸŽ® Quiz</h1>
        <p style="margin-bottom:20px; color:#666;">Digite seu nome para entrar:</p>
        <input type="text" id="nickname" placeholder="Seu Nome/Apelido" style="padding:20px; font-size:1.5rem; text-align:center; border-radius:10px; border:2px solid #ddd; margin-bottom:15px; width:100%;">
        <button onclick="joinGame()" class="btn blue">ENTRAR NO JOGO</button>
        <div style="margin-top:20px; font-size:0.8rem; color:#888;">
            Se o jogo travar, clique abaixo:<br>
            <button onclick="forceReset()" style="background:none; border:none; color:red; text-decoration:underline; cursor:pointer;">Limpar SessÃ£o</button>
        </div>
    </div>

    <div id="gameScreen" class="player-container hidden">
        <h2 id="statusText" style="margin:10px 0;">Aguardando...</h2>
        <div class="player-grid" id="controls">
            <button class="p-btn red" onclick="sendAnswer(0)"></button>
            <button class="p-btn blue" onclick="sendAnswer(1)"></button>
            <button class="p-btn yellow" onclick="sendAnswer(2)"></button>
            <button class="p-btn green" onclick="sendAnswer(3)"></button>
        </div>
    </div>

    <div id="resultScreen" class="hidden" style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; text-align:center;">
        <h1 id="resIcon" style="font-size:6rem;"></h1>
        <h1 id="resTitle" style="font-size:3rem;"></h1>
        <h2 id="resScore"></h2>
    </div>

    <script type="module">
        import { db, ref, set, push, onValue, update } from './game.js';

        // Tenta recuperar ID antigo, mas nÃ£o conecta automaticamente se estiver na tela de login
        let myId = localStorage.getItem('k_uid');
        const audio = document.getElementById('clickSfx');
        const playSfx = () => { audio.currentTime=0; audio.play().catch(()=>{}); };
        const avatars = ["ðŸ¶","ðŸ±","ðŸ­","ðŸ¹","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ¨","ðŸ¯","ðŸ¦","ðŸ®","ðŸ·","ðŸ¸","ðŸµ","ðŸ¦„","ðŸ™","ðŸ‘½","ðŸ¤–","ðŸ‘»","ðŸ¤¡","ðŸ¤ ","ðŸ’©","ðŸŒµ","ðŸ„","ðŸ•","ðŸ”","ðŸš€","âš½"];

        // Se jÃ¡ tem ID e a pÃ¡gina recarregou, tenta reconectar direto
        // Mas se o usuÃ¡rio caiu na tela de login, o botÃ£o ENTRAR vai criar um novo ID
        if(myId && document.getElementById('gameScreen').classList.contains('hidden')) {
            // Verifica se o ID ainda Ã© vÃ¡lido no banco antes de pular o login
            // (LÃ³gica simplificada: Assume que se tem ID, tenta conectar)
             connect(); 
        }

        window.joinGame = function() {
            const name = document.getElementById('nickname').value.trim();
            if(!name) return alert("Por favor, digite um nome!");
            
            // FILTRO DE NOMES
            const bad = ["admin","host","palavrao","teste"]; 
            if(bad.some(b => name.toLowerCase().includes(b))) return alert("Nome invÃ¡lido!");

            playSfx();

            // *** CORREÃ‡ÃƒO DO MULTIPLAYER ***
            // Sempre gera um NOVO ID ao clicar em Entrar, para garantir que abas diferentes
            // sejam jogadores diferentes.
            const refP = push(ref(db, 'players'));
            myId = refP.key;
            localStorage.setItem('k_uid', myId);

            set(refP, {
                name: name,
                avatar: avatars[Math.floor(Math.random()*avatars.length)],
                score: 0, 
                streak: 0, 
                status: 'thinking',
                lastAnswer: null
            }).then(() => {
                connect();
            });
        }

        window.forceReset = function() {
            localStorage.removeItem('k_uid');
            location.reload();
        }

        function connect() {
            // Esconde login e mostra jogo
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // Monitora MEU status
            onValue(ref(db, `players/${myId}`), (snap) => {
                const data = snap.val();
                
                // Se meu ID nÃ£o existe mais no banco (Admin limpou), volta pro login
                if(!data) { 
                    localStorage.removeItem('k_uid'); 
                    location.reload(); 
                    return; 
                }

                const gameDiv = document.getElementById('gameScreen');
                const resDiv = document.getElementById('resultScreen');

                // LÃ³gica de telas
                if(data.status === 'thinking' && data.lastAnswer == null) {
                    // Modo: Respondendo
                    gameDiv.classList.remove('hidden'); resDiv.classList.add('hidden');
                    document.body.style.background = "#f0f2f5";
                    document.getElementById('statusText').innerText = "Escolha sua resposta!";
                    document.getElementById('controls').style.opacity = "1";
                    document.querySelectorAll('.p-btn').forEach(b => b.disabled = false);
                }
                else if(data.status === 'correct' || data.status === 'wrong') {
                    // Modo: Resultado
                    gameDiv.classList.add('hidden'); resDiv.classList.remove('hidden');
                    
                    if(data.status === 'correct') {
                        document.body.style.background = "#26890c";
                        document.getElementById('resTitle').innerText = "ACERTOU!";
                        document.getElementById('resIcon').innerText = "ðŸ¤©";
                    } else {
                        document.body.style.background = "#e21b3c";
                        document.getElementById('resTitle').innerText = "ERROU...";
                        document.getElementById('resIcon').innerText = "ðŸ˜¢";
                    }
                    document.getElementById('resScore').innerText = `${data.score} pts`;
                }
            });
        }

        window.sendAnswer = function(idx) {
            if(!myId) return;
            playSfx();
            if(navigator.vibrate) navigator.vibrate(50);
            
            // Envia resposta + timestamp
            update(ref(db, `players/${myId}`), { 
                lastAnswer: idx, 
                answerTime: Date.now() 
            });
            
            document.getElementById('statusText').innerText = "Resposta Enviada! Aguarde...";
            document.getElementById('controls').style.opacity = "0.5";
            document.querySelectorAll('.p-btn').forEach(b => b.disabled = true);
        }
    </script>
</body>
</html>