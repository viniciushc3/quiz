<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos exclusivos para a tela de espera */
        .waiting-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            animation: pulse 1.5s infinite;
        }
        .waiting-icon { font-size: 4rem; margin-bottom: 20px; }
        .waiting-text { font-size: 1.5rem; color: #555; font-weight: bold; }
        
        @keyframes pulse {
            0% { opacity: 0.6; transform: scale(0.98); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(0.98); }
        }
    </style>
</head>
<body>
    <audio id="clickSfx" src="https://www.soundjay.com/buttons/sounds/button-30.mp3"></audio>

    <div id="loginScreen" class="player-container" style="justify-content:center;">
        <h1 style="font-size:3rem; margin-bottom:20px;">üéÆ Quiz</h1>
        <input type="text" id="nickname" placeholder="Seu Nome / Apelido" maxlength="12"
               style="padding:20px; font-size:1.5rem; text-align:center; border-radius:10px; border:2px solid #ddd; margin-bottom:15px; width:100%;">
        <button onclick="joinGame()" class="btn blue">ENTRAR</button>
        <button onclick="clearSession()" class="btn" style="background:#ccc; color:#333; margin-top:20px;">Sair</button>
    </div>

    <div id="gameScreen" class="player-container hidden">
        
        <div id="waitMessage" class="waiting-box hidden">
            <div class="waiting-icon">‚è≥</div>
            <div class="waiting-text">Aguardando o in√≠cio da rodada...</div>
            <small style="margin-top:10px; color:#888;">Olhe para a TV</small>
        </div>

        <div id="activeGameUI" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <h2 id="statusText" style="margin:10px 0; text-align:center;">Sua vez! Escolha:</h2>
            <div class="player-grid" id="controls">
                <button class="p-btn red" onclick="sendAnswer(0)"></button>
                <button class="p-btn blue" onclick="sendAnswer(1)"></button>
                <button class="p-btn yellow" onclick="sendAnswer(2)"></button>
                <button class="p-btn green" onclick="sendAnswer(3)"></button>
            </div>
        </div>
    </div>

    <div id="resultScreen" class="hidden" style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px;">
        <h1 id="resIcon" style="font-size:6rem;"></h1>
        <h1 id="resTitle" style="font-size:3rem;"></h1>
        <h2 id="resScore"></h2>
    </div>

    <script type="module">
        import { db, ref, set, push, onValue, update } from './game.js';

        let myId = localStorage.getItem('k_uid');
        let currentScreenState = 'lobby'; // lobby, question, leaderboard, podium
        let myPlayerData = null;

        const audio = document.getElementById('clickSfx');
        const playSfx = () => { audio.currentTime=0; audio.play().catch(()=>{}); };
        const avatars = ["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üêØ","ü¶Å","üêÆ","üê∑","üê∏","üêµ","ü¶Ñ","üêô","üëΩ","ü§ñ","üëª","ü§°","ü§†","üí©","üåµ","üçÑ","üçï","üçî","üöÄ","‚öΩ"];

        // Tenta reconectar se j√° tiver ID
        if(myId) connect();

        window.joinGame = function() {
            const name = document.getElementById('nickname').value.trim();
            if(!name) return alert("Digite um nome!");
            const bad = ["admin","host","palavrao"]; 
            if(bad.some(b => name.toLowerCase().includes(b))) return alert("Nome inv√°lido!");

            playSfx();
            const refP = push(ref(db, 'players'));
            myId = refP.key;
            localStorage.setItem('k_uid', myId);

            set(refP, {
                name: name,
                avatar: avatars[Math.floor(Math.random()*avatars.length)],
                score: 0, streak: 0, status: 'thinking'
            }).then(() => connect());
        }

        window.clearSession = function() { localStorage.removeItem('k_uid'); location.reload(); }

        function connect() {
            document.getElementById('loginScreen').classList.add('hidden');
            
            // 1. OUVINTE DO ESTADO DO JOGO (Para saber se √© Lobby ou Pergunta)
            onValue(ref(db, 'gameState'), (snap) => {
                const st = snap.val();
                if(!st) return;
                currentScreenState = st.screen;
                updateInterface(); // Atualiza a tela sempre que o jogo mudar
            });

            // 2. OUVINTE DO JOGADOR (Para saber meus pontos e se acertei)
            onValue(ref(db, `players/${myId}`), (snap) => {
                const data = snap.val();
                if(!data) { localStorage.removeItem('k_uid'); location.reload(); return; }
                myPlayerData = data;
                updateInterface(); // Atualiza a tela sempre que meu status mudar
            });
        }

        // FUN√á√ÉO CENTRAL QUE DECIDE O QUE MOSTRAR NA TELA
        function updateInterface() {
            if(!myPlayerData) return;

            const gameDiv = document.getElementById('gameScreen');
            const resDiv = document.getElementById('resultScreen');
            const waitBox = document.getElementById('waitMessage');
            const activeUI = document.getElementById('activeGameUI');

            // Reset b√°sico
            resDiv.classList.add('hidden');
            gameDiv.classList.remove('hidden');

            // --- L√ìGICA DE ESTADOS ---

            // CASO 1: Estamos no Lobby, Ranking ou P√≥dio -> MOSTRAR ESPERA
            if (currentScreenState === 'lobby' || currentScreenState === 'leaderboard' || currentScreenState === 'podium') {
                waitBox.classList.remove('hidden');
                activeUI.classList.add('hidden');
                document.body.style.background = "#f0f2f5";
                
                // Texto personalizado dependendo da tela
                const txt = waitBox.querySelector('.waiting-text');
                if(currentScreenState === 'lobby') txt.innerText = "Aguardando o in√≠cio...";
                else if(currentScreenState === 'podium') txt.innerText = "Olhe para o P√≥dio! üèÜ";
                else txt.innerText = "Veja o Ranking na TV üìä";
                return;
            }

            // CASO 2: Estamos em uma Pergunta
            if (currentScreenState === 'question') {
                
                // Se eu ainda estou "pensando" e n√£o respondi -> MOSTRAR BOT√ïES
                if (myPlayerData.status === 'thinking' && (myPlayerData.lastAnswer === undefined || myPlayerData.lastAnswer === null)) {
                    waitBox.classList.add('hidden');
                    activeUI.classList.remove('hidden');
                    document.body.style.background = "#f0f2f5";
                    
                    document.getElementById('statusText').innerText = "Sua vez! Escolha:";
                    document.getElementById('controls').style.opacity = "1";
                    document.getElementById('controls').style.pointerEvents = "auto";
                }
                
                // Se eu j√° respondi -> MOSTRAR ESPERA (BLOQUEADO)
                else if (myPlayerData.lastAnswer !== undefined && myPlayerData.lastAnswer !== null && myPlayerData.status === 'thinking') {
                    waitBox.classList.remove('hidden');
                    activeUI.classList.add('hidden');
                    waitBox.querySelector('.waiting-text').innerText = "Resposta Enviada! ü§û";
                }

                // Se j√° saiu o resultado (Acertei ou Errei) -> MOSTRAR TELA DE RESULTADO
                else if (myPlayerData.status === 'correct' || myPlayerData.status === 'wrong') {
                    gameDiv.classList.add('hidden'); // Esconde controles
                    resDiv.classList.remove('hidden'); // Mostra resultado

                    if(myPlayerData.status === 'correct') {
                        document.body.style.background = "#26890c";
                        document.getElementById('resTitle').innerText = "ACERTOU!";
                        document.getElementById('resIcon').innerText = "ü§©";
                    } else {
                        document.body.style.background = "#e21b3c";
                        document.getElementById('resTitle').innerText = "ERROU...";
                        document.getElementById('resIcon').innerText = "üò¢";
                    }
                    document.getElementById('resScore').innerText = `${myPlayerData.score} pts`;
                }
            }
        }

        window.sendAnswer = function(idx) {
            if(!myId) return;
            playSfx();
            if(navigator.vibrate) navigator.vibrate(50);
            
            // Efeito visual imediato
            document.getElementById('controls').style.opacity = "0.5";
            document.getElementById('controls').style.pointerEvents = "none";
            document.getElementById('statusText').innerText = "Enviando...";

            update(ref(db, `players/${myId}`), { lastAnswer: idx, answerTime: Date.now() });
        }
    </script>
</body>
</html>